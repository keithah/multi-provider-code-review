name: Multi-Provider Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Note: pull_request_review trigger removed to prevent duplicate runs
  # when the bot posts its own review comment
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
      review_providers:
        description: "Comma-separated list of model providers (validated against allowed patterns)"
        required: false
        type: string

# Cancel in-progress runs for the same PR to prevent duplicate reviews
# Use PR number + head SHA (not merge commit SHA) for uniqueness per commit
concurrency:
  group: review-${{ github.event.pull_request.number || inputs.pr_number }}-${{ github.event.pull_request.head.sha || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  review:
    runs-on: ubicloud-standard-2
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for incremental review git diff
      - name: Resolve PR number
        id: resolve-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          pr="${{ github.event.pull_request.number || '' }}"
          if [ -n "$pr" ]; then
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          pr="${{ inputs.pr_number || '' }}"
          if [ -n "$pr" ]; then
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.event_name }}" = "push" ]; then
            pr=$(gh pr list --state open --head "$BRANCH" --json number --jq '.[0].number')
            if [ -n "$pr" ]; then
              echo "pr=$pr" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "No PR found for this event/branch; skipping review."
          echo "pr=" >> "$GITHUB_OUTPUT"
      - name: Validate Review Providers Input
        if: ${{ inputs.review_providers != '' }}
        run: |
          # Validate REVIEW_PROVIDERS format: only allow alphanumeric, dots, hyphens, underscores, slashes, colons, and commas
          # Examples of valid formats: "openrouter/model:free", "opencode/model-name", "provider/vendor/model:tag", "gemini-2.0-flash-exp"
          PROVIDERS="${{ inputs.review_providers }}"
          if ! echo "$PROVIDERS" | grep -qE '^[a-zA-Z0-9_/.-]+:[a-zA-Z0-9_/.-]+(,[a-zA-Z0-9_/.-]+:[a-zA-Z0-9_/.-]+)*$'; then
            echo "Error: Invalid REVIEW_PROVIDERS format. Must be comma-separated provider/model:tag format."
            echo "Examples: 'openrouter/mistralai/model:free' or 'opencode/gemini-2.0-flash-exp:free'"
            echo "Received: $PROVIDERS"
            exit 1
          fi
          echo "Providers validated: $PROVIDERS"
      - name: Validate Secrets and Configuration
        run: |
          # Check if OPENROUTER_API_KEY is available for fork PRs
          if [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            if [ -z "${{ secrets.OPENROUTER_API_KEY }}" ]; then
              echo "‚ö†Ô∏è  Warning: Fork PR detected without OPENROUTER_API_KEY secret."
              echo "    Review step will be SKIPPED (see workflow gate condition at line 99)."
              echo "    To enable reviews for fork PRs, add OPENROUTER_API_KEY to repository secrets."
            else
              echo "‚úÖ OPENROUTER_API_KEY available for fork PR - review will run"
            fi
          else
            echo "‚úÖ Not a fork PR - all secrets available"
          fi

          # Log provider discovery strategy
          if [ -n "${{ inputs.review_providers }}" ]; then
            echo "üìã Using explicit providers: ${{ inputs.review_providers }}"
          else
            echo "üîç Using dynamic provider discovery (see workflow comments for fallback chain)"
          fi
      - name: Install OpenCode CLI
        run: npm install -g opencode-ai@1.1.32
      # Run review if: (1) PR number found, AND (2) either not a fork PR OR has OpenRouter API key
      # Fork PRs can run using free opencode providers if OPENROUTER_API_KEY is not available
      - name: Multi-Provider Code Review
        if: ${{ steps.resolve-pr.outputs.pr != '' && (github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false || env.OPENROUTER_API_KEY != '') }}
        uses: ./
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.resolve-pr.outputs.pr }}
          # Dynamic Model Discovery (DEFAULT_CONFIG.providers = [])
          # 1. Fetches best free models from OpenRouter API (if OPENROUTER_API_KEY set)
          # 2. Fetches best free models from OpenCode CLI (if installed)
          # 3. Falls back to FALLBACK_STATIC_PROVIDERS (hardcoded in src/config/defaults.ts):
          #    - openrouter/mistralai/devstral-2512:free
          #    - openrouter/xiaomi/mimo-v2-flash:free
          #    Note: These are automatic fallbacks, not configurable via env vars
          # 4. Final fallback: opencode/minimax-m2.1-free (hardcoded in src/providers/registry.ts)
          #
          # To override: Set REVIEW_PROVIDERS env var with comma-separated model list
          # See: src/config/defaults.ts and src/providers/registry.ts for implementation
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          REVIEW_PROVIDERS: ${{ inputs.review_providers }}
