name: Multi-Provider Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  # Note: pull_request_review trigger removed to prevent duplicate runs
  # when the bot posts its own review comment
  push:
    branches: [main, ts-rewrite]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull request number to review"
        required: true
      review_providers:
        description: "Comma-separated list of model providers (validated against allowed patterns)"
        required: false
        type: string

# Cancel in-progress runs for the same PR to prevent duplicate reviews
# Use PR number + head SHA (not merge commit SHA) for uniqueness per commit
concurrency:
  # PR-aware grouping to prevent duplicate reviews per commit
  group: review-${{ (github.event.pull_request && github.event.pull_request.number) || inputs.pr_number || 'manual' }}-${{ (github.event.pull_request && github.event.pull_request.head && github.event.pull_request.head.sha) || github.sha }}
  cancel-in-progress: true

# Permissions: Principle of least privilege
# Only grant the minimum permissions required for code review functionality
# Security rationale:
# - contents: read - Required to checkout code and read PR diffs (minimal read access)
# - pull-requests: write - Required to post review comments and inline suggestions (no merge access)
# - actions: read - Required for concurrency control to prevent duplicate reviews (read-only)
# NOT granted: contents: write (cannot modify code), issues: write (cannot create issues)
permissions:
  contents: read        # Read repository code and PR diffs
  pull-requests: write  # Post review comments and summaries
  actions: read         # Check workflow status (for concurrency control)

jobs:
  review:
    # Internal PRs, pushes, and manual runs (non-fork)
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    env:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      IS_FORK: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for incremental review git diff
      - name: Resolve PR number
        id: resolve-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          pr="${{ github.event.pull_request.number || '' }}"
          if [ -n "$pr" ]; then
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          pr="${{ inputs.pr_number || '' }}"
          if [ -n "$pr" ]; then
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.event_name }}" = "push" ]; then
            pr=$(gh pr list --state open --head "$BRANCH" --json number --jq '.[0].number')
            if [ -n "$pr" ]; then
              echo "pr=$pr" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          echo "No PR found for this event/branch; skipping review."
          echo "pr=" >> "$GITHUB_OUTPUT"
      - name: Validate Review Providers Input
        # Only validate if providers are explicitly specified (not empty and not null)
        # GitHub Actions treats missing inputs as empty string, so this condition is correct
        if: ${{ inputs.review_providers != '' && inputs.review_providers != null }}
        run: node scripts/validate-providers.js "${{ inputs.review_providers }}"
      - name: Validate Secrets and Configuration
        run: |
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "‚ö†Ô∏è  Warning: OPENROUTER_API_KEY not set. OpenRouter providers will be skipped; free OpenCode providers will be used."
          else
            echo "‚úÖ OPENROUTER_API_KEY available - full provider access enabled"
          fi

          # Log provider discovery strategy
          if [ -n "${{ inputs.review_providers }}" ]; then
            echo "üìã Using explicit providers: ${{ inputs.review_providers }}"
          else
            echo "üîç Using dynamic provider discovery (see workflow comments for fallback chain)"
          fi
      - name: Install OpenCode CLI
        # Version pinning strategy:
        # - Pin to latest published npm version known-good for CLI commands
        # - Update strategy: Test quarterly (Jan, Apr, Jul, Oct) with full suite + smoke tests
        run: npm install -g opencode-ai@1.1.35
      # Run review if: PR number found. Fork PRs run with free providers when OPENROUTER_API_KEY is unavailable.
      - name: Warn Fork PR Without OpenRouter Key
        if: steps.resolve-pr.outputs.pr != '' && github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true && env.OPENROUTER_API_KEY == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ÑπÔ∏è  Fork PR detected without OPENROUTER_API_KEY."
          if ! command -v opencode-ai >/dev/null 2>&1; then
            echo "‚ùå OpenCode CLI not available. Install opencode-ai or set OPENROUTER_API_KEY for premium providers."
            exit 1
          fi
          echo "‚úÖ Proceeding with free providers only (OpenCode CLI / built-in fallbacks)."
          echo "To enable premium OpenRouter models, add OPENROUTER_API_KEY to repository or environment secrets."

      - name: Multi-Provider Code Review
        # Run if PR number resolved (supports pull_request, push, workflow_dispatch)
        if: steps.resolve-pr.outputs.pr != ''
        uses: ./
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.resolve-pr.outputs.pr }}
          REVIEW_PROVIDERS: ${{ inputs.review_providers }}
          # Dynamic Model Discovery:
          # By default (when REVIEW_PROVIDERS is empty or not set), the system automatically
          # discovers and selects the best available free models through a multi-tier fallback:
          # 1. OpenRouter API (if OPENROUTER_API_KEY is set)
          # 2. OpenCode CLI free models (if opencode-ai is installed)
          # 3. Hardcoded fallback providers (see src/config/defaults.ts)
          #
          # To use specific providers instead of auto-discovery:
          # - Set inputs.review_providers for workflow_dispatch
          # - syncEnvFromInputs() in main.ts reads this input and sets process.env.REVIEW_PROVIDERS
          # See documentation for provider string format and available models
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

  review-fork:
    # Fork PRs run in isolated, read-only context with no repo secrets
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    env:
      OPENROUTER_API_KEY: '' # ensure repo secrets are not exposed to forks
      IS_FORK: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Resolve PR number
        id: resolve-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          pr="${{ github.event.pull_request.number || '' }}"
          if [ -n "$pr" ]; then
            echo "pr=$pr" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "No PR found for this event/branch; skipping review."
          echo "pr=" >> "$GITHUB_OUTPUT"
      - name: Validate Review Providers Input
        if: ${{ inputs.review_providers != '' && inputs.review_providers != null }}
        run: node scripts/validate-providers.js "${{ inputs.review_providers }}"
      - name: Validate Fork Configuration
        run: |
          echo "‚ÑπÔ∏è  Fork PR detected - running in isolated mode with no repository secrets."
          if [ -z "$OPENROUTER_API_KEY" ]; then
            echo "‚úÖ Secrets unavailable (expected for forks); using free providers only."
          fi
      - name: Install OpenCode CLI
        run: npm install -g opencode-ai@1.1.36
      - name: Warn Fork PR Without OpenRouter Key
        if: steps.resolve-pr.outputs.pr != '' && env.OPENROUTER_API_KEY == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ÑπÔ∏è  Fork PR detected without OPENROUTER_API_KEY."
          if ! command -v opencode-ai >/dev/null 2>&1; then
            echo "‚ùå OpenCode CLI not available. Install opencode-ai or set OPENROUTER_API_KEY for premium providers."
            exit 1
          fi
          echo "‚úÖ Proceeding with free providers only (OpenCode CLI / built-in fallbacks)."
      - name: Multi-Provider Code Review (Fork)
        if: steps.resolve-pr.outputs.pr != ''
        uses: ./
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.resolve-pr.outputs.pr }}
          REVIEW_PROVIDERS: ${{ inputs.review_providers }}
        env:
          OPENROUTER_API_KEY: '' # enforce zero secret access
