# Milestone v0.5: MVP - GitHub Commit Suggestions

**Status:** ✅ SHIPPED 2026-02-05
**Phases:** 1-5
**Total Plans:** 22

## Overview

This roadmap delivered one-click commit suggestion functionality for the multi-provider code review GitHub Action. Starting from existing infrastructure (Finding.suggestion field, AST analysis, orchestration pipeline), we added suggestion formatting, extended LLM prompts to generate fixes, implemented multi-line support, and layered on validation to ensure quality. Each phase built on the previous, validating foundational capabilities before adding complexity.

## Phases

### Phase 1: Core Suggestion Formatting

**Goal:** Convert Finding.suggestion text to valid GitHub suggestion markdown blocks with accurate line mapping

**Depends on:** Nothing (foundation phase)

**Plans:** 3 plans

Plans:
- [x] 01-01: TDD: Suggestion block formatter (formatSuggestionBlock, backtick escaping)
- [x] 01-02: TDD: Suggestion line validator (validateSuggestionLine, diff integration)
- [x] 01-03: Integration: Update formatters and comment poster to use suggestion utilities

**Details:**

**Requirements:** FR-1.1 (Single-line formatting), FR-1.2 (Escaping), FR-1.3 (Line accuracy)

**Success Criteria Achieved:**
1. ✓ Single-line suggestion renders with "Commit suggestion" button in GitHub UI
2. ✓ Suggestions containing backticks render correctly without markdown conflicts
3. ✓ Suggestion blocks appear at correct diff line positions (no misalignment errors)
4. ✓ Invalid line numbers are rejected before posting (fail gracefully, not silently)

**Key Decisions:**
- Use formatSuggestionBlock for consistent suggestion rendering across both formatters
- Validate suggestion lines in CommentPoster before posting to prevent API errors
- Gracefully degrade invalid suggestions to plain text rather than dropping finding

**Completed:** 2026-02-05

---

### Phase 2: LLM Fix Generation Integration

**Goal:** Extend LLM pipeline to generate and extract fix suggestions during review pass

**Depends on:** Phase 1 (formatting must work before generating real fixes)

**Plans:** 4 plans

Plans:
- [x] 02-01: Extend PromptBuilder with fix generation instructions
- [x] 02-02: TDD: Suggestion sanity validation function
- [x] 02-03: Integrate suggestion validation into parser
- [x] 02-04: Token-aware context management for suggestion skip

**Details:**

**Requirements:** FR-2.1 (Fix generation prompts), FR-2.2 (Parse suggestion field), FR-2.3 (Graceful degradation), FR-2.4 (Token-aware context)

**Success Criteria Achieved:**
1. ✓ All LLM providers (Claude, Gemini, OpenRouter, OpenCode, Codex) generate fix suggestions when finding issues
2. ✓ Parser successfully extracts Finding.suggestion field from LLM responses across all providers
3. ✓ When suggestion is unavailable or invalid, finding still posts without suggestion block (description-only fallback)
4. ✓ Context window truncation is prevented via token counting, respecting per-provider limits
5. ✓ End-to-end pipeline works: prompt -> LLM analysis -> parse -> format -> post to GitHub

**Key Decisions:**
- Use single 50k token threshold (not tiered) for simplicity - conservative for small windows, reasonable for large
- Skip entire suggestion instructions (not just examples) when diff is large - cleaner schema reduction
- Log skip at debug level (not warn/info) - normal flow, not exceptional condition

**Completed:** 2026-02-05

---

### Phase 3: Multi-Line and Advanced Formatting

**Goal:** Support suggestions spanning multiple consecutive lines with proper deletion handling

**Depends on:** Phase 2 (single-line end-to-end must work first)

**Plans:** 3 plans

Plans:
- [x] 03-01: TDD: Multi-line range validation (validateSuggestionRange)
- [x] 03-02: TDD: Hunk boundary detection (isRangeWithinSingleHunk)
- [x] 03-03: Integration: Wire validation into CommentPoster with multi-line API support

**Details:**

**Requirements:** FR-3.1 (Multi-line suggestions), FR-3.2 (Deletion handling), FR-3.3 (Multi-line escaping)

**Success Criteria Achieved:**
1. ✓ Suggestions replacing 2+ consecutive lines render with commit buttons
2. ✓ All lines in suggestion range are validated to exist on RIGHT side of diff (new code)
3. ✓ Suggestions spanning deleted lines are rejected before posting
4. ✓ Multi-line suggestions containing backticks render correctly with proper escaping
5. ✓ GitHub's batch commit feature works for multiple multi-line suggestions in one review

**Key Decisions:**
- Use logger.debug (not warn) for suggestion validation failures (normal flow, not exceptional)
- Hunk boundary check runs after consecutive check (defensive layer, better error messages)
- Delete position parameter when using line-based multi-line API (GitHub API constraint)
- Sort comments by file path then line for optimal batch commit UX

**Completed:** 2026-02-05

---

### Phase 4: Validation and Quality

**Goal:** Add syntax validation, multi-provider consensus, and learning feedback to improve fix reliability

**Depends on:** Phase 3 (core functionality complete before quality layers)

**Plans:** 9 plans

Plans:
- [x] 04-01: TDD: Syntax validator (tree-sitter ERROR/MISSING node detection)
- [x] 04-02: TDD: AST comparator (structural equivalence for consensus)
- [x] 04-03: TDD: Confidence calculator (hybrid scoring with thresholds)
- [x] 04-04: TDD: Suppression tracker + provider weight adjustment (dismissal learning)
- [x] 04-05: Config schema + consensus integration (AST-based suggestion agreement, hasConsensus wiring)
- [x] 04-06: Integration: Wire validation, consensus, code graph context into CommentPoster
- [x] 04-07: Prompt enrichment with learned patterns (feedback-informed LLM prompts)
- [x] 04-08: TDD: Acceptance detector (track committed suggestions for positive feedback)
- [x] 04-09: Gap closure: Wire learning/validation trackers into setup.ts runtime

**Details:**

**Requirements:** FR-4.1 (Syntax validation), FR-4.2 (Multi-provider consensus), FR-4.3 (Context-aware fixes), FR-4.4 (Learning from feedback)

**Success Criteria Achieved:**
1. ✓ Suggested fixes are validated with tree-sitter before posting (syntax errors rejected)
2. ✓ Critical severity findings require multi-provider consensus before suggesting fixes (configurable threshold)
3. ✓ LLM prompts include project-specific context from existing code graph
4. ✓ Dismissed suggestions (with thumbs-down reactions) are tracked via learning system
5. ✓ Accepted suggestions (committed via "Commit suggestion" button or thumbs-up) are tracked for provider weight learning
6. ✓ Provider fix quality metrics are captured via existing analytics

**Key Decisions:**
- Use 'cli-mode' key for CLI suppression tracker (isolated from production)
- Use '${owner}/${repo}' key for production tracker (proper repo scoping)
- Pass undefined for codeGraph at setup time (requires files unavailable until PR load)
- Wire trackers into both createComponents and createComponentsForCLI for consistency

**Completed:** 2026-02-05

---

### Phase 5: Complete Learning Feedback Loop

**Goal:** Wire AcceptanceDetector into runtime to enable positive feedback learning and complete the bi-directional weight adjustment system

**Depends on:** Phase 4 (AcceptanceDetector implementation exists, needs runtime integration)

**Plans:** 3 plans

Plans:
- [x] 05-01: Runtime wiring: Add AcceptanceDetector to setup.ts and ReviewComponents
- [x] 05-02: Orchestration: Add acceptance detection to review execution flow
- [x] 05-03: Gap closure: Wire FeedbackFilter to record negative feedback to ProviderWeightTracker

**Details:**

**Requirements:** FR-4.4 completion (Learning from feedback - acceptance tracking component)

**Gap Closure:** Addresses tech debt from v0.5 audit (AcceptanceDetector orphaned, positive feedback loop incomplete)

**Success Criteria Achieved:**
1. ✓ AcceptanceDetector instantiated in setup.ts for both CLI and production modes
2. ✓ Orchestrator calls detectFromCommits() when PR updated
3. ✓ Orchestrator calls detectFromReactions() for comment reactions
4. ✓ Accepted suggestions feed ProviderWeightTracker to increase provider weights
5. ✓ Provider weights increase on acceptances, decrease on dismissals (bi-directional learning)
6. ✓ End-to-end acceptance tracking works: suggestion posted -> user accepts -> weight increases

**Key Decisions:**
- Use same provider extraction pattern as AcceptanceDetector for consistency
- Make providerWeightTracker optional in FeedbackFilter constructor for backward compatibility
- Record feedback during loadSuppressed() when detecting thumbs-down reactions

**Completed:** 2026-02-05

---

## Milestone Summary

**Key Decisions:**
- Use GitHub's native suggestion syntax (leverages built-in UI)
- Prompt LLMs for fixes during initial review (single-pass efficiency)
- Fallback to description-only (better to surface issue without fix)
- 50k token threshold for skipping suggestions (prevents hallucination)
- Validate suggestions in CommentPoster vs formatters (proper separation of concerns)
- AST-based consensus for multi-provider fixes (structural equivalence)
- Bi-directional learning from acceptances and dismissals (complete feedback loop)

**Issues Resolved:**
- Line number misalignment - solved via GitHub's modern line/start_line API
- Context truncation causing hallucinated fixes - solved via 50k token threshold
- Suggestions spanning deletions failing silently - solved via RIGHT-side-only validation
- Orphaned AcceptanceDetector - solved via Phase 5 runtime wiring
- Incomplete feedback loop - solved via FeedbackFilter integration

**Technical Debt Incurred:**
- CodeGraph cannot be injected at setup time (requires FileChange[] only available during orchestration) - deferred architectural improvement
- Human verification pending for GitHub UI rendering of suggestion buttons (code correct, UI test needed in real PR)

---

_For current project status, see .planning/PROJECT.md_
