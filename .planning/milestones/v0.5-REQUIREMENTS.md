# Requirements Archive: v0.5 MVP - GitHub Commit Suggestions

**Archived:** 2026-02-05
**Status:** ‚úÖ SHIPPED

This is the archived requirements specification for v0.5 MVP.
For current requirements, see `.planning/REQUIREMENTS.md` (will be created for next milestone).

---

# Requirements

**Project:** GitHub Commit Suggestions for Multi-Provider Code Review
**Last Updated:** 2026-02-05
**Status:** Complete

## Overview

This document categorizes requirements for adding one-click commit suggestion functionality to the multi-provider code review action. Requirements are organized by implementation phase based on component dependencies and complexity progression identified in research.

## Functional Requirements

### Phase 1: Core Suggestion Formatting

**FR-1.1: Single-Line Suggestion Formatting** ‚úÖ SHIPPED
- **Description:** Format a single-line code fix as a GitHub suggestion block
- **Acceptance Criteria:**
  - Given `Finding.suggestion` text for a single line
  - When SuggestionFormatter processes it
  - Then output is valid ````suggestion` markdown block
  - And block renders with commit button in GitHub UI
- **Priority:** CRITICAL (table stakes)
- **Outcome:** Implemented in formatSuggestionBlock utility (src/utils/suggestion-formatter.ts), 15 tests pass

**FR-1.2: Suggestion Block Escaping** ‚úÖ SHIPPED
- **Description:** Prevent markdown conflicts when code contains backticks
- **Acceptance Criteria:**
  - Given suggestion text containing triple backticks
  - When formatter escapes content
  - Then uses 4+ backtick delimiters to prevent block termination
  - And rendered block is syntactically correct
- **Priority:** HIGH (pitfall prevention)
- **Outcome:** Dynamic fence delimiter implemented, handles nested backticks correctly

**FR-1.3: Line Number Accuracy** ‚úÖ SHIPPED
- **Description:** Map finding line numbers to GitHub diff positions correctly
- **Acceptance Criteria:**
  - Given a finding with file path and line number
  - When formatter determines diff position
  - Then uses GitHub's `line`/`start_line` API parameters (not deprecated `position`)
  - And validates line exists on RIGHT side of diff
- **Priority:** CRITICAL (primary failure mode)
- **Outcome:** Implemented in validateSuggestionLine (src/utils/suggestion-validator.ts), 12 tests pass

### Phase 2: LLM Fix Generation Integration

**FR-2.1: Fix Generation in Prompts** ‚úÖ SHIPPED
- **Description:** Extend LLM prompts to request fix suggestions
- **Acceptance Criteria:**
  - Given PromptBuilder creating review prompt
  - When building prompt for any provider
  - Then includes fix generation instructions uniformly
  - And provides sufficient context for accurate fixes
- **Priority:** CRITICAL (core feature)
- **Outcome:** SUGGESTION FIELD instructions added to prompt template, uniform across all providers

**FR-2.2: Parse Suggestion Field from LLM** ‚úÖ SHIPPED
- **Description:** Extract `suggestion` field from LLM responses
- **Acceptance Criteria:**
  - Given LLM response with finding and optional suggestion
  - When parser processes response
  - Then extracts `Finding.suggestion` when present
  - And handles missing suggestions gracefully (no error)
- **Priority:** CRITICAL (core feature)
- **Outcome:** Parser extracts and validates suggestions with sanity checks

**FR-2.3: Graceful Degradation** ‚úÖ SHIPPED
- **Description:** Fallback to description-only when fix unavailable
- **Acceptance Criteria:**
  - Given finding with no valid suggestion
  - When formatting comment
  - Then posts finding without suggestion block
  - And does NOT suppress the finding
- **Priority:** HIGH (user experience)
- **Outcome:** Implemented in CommentPoster with regex-based suggestion block removal

**FR-2.4: Token-Aware Context** ‚úÖ SHIPPED
- **Description:** Prevent context truncation causing hallucinated fixes
- **Acceptance Criteria:**
  - Given file content for LLM prompt
  - When building context
  - Then implements token counting before prompt
  - And prioritizes essential context (changed lines + function signature + imports)
  - And respects per-provider limits (Claude: 200k, GPT-4: 128k, Gemini: 1M)
- **Priority:** HIGH (pitfall prevention)
- **Outcome:** shouldSkipSuggestions helper with 50k token threshold, conditionally excludes suggestion instructions

### Phase 3: Multi-Line and Advanced Formatting

**FR-3.1: Multi-Line Suggestions** ‚úÖ SHIPPED
- **Description:** Support suggestions spanning multiple lines
- **Acceptance Criteria:**
  - Given suggestion replacing 2+ consecutive lines
  - When formatter creates block
  - Then uses `start_line` and `line` range parameters
  - And validates all lines in range exist on RIGHT side of diff
- **Priority:** CRITICAL (table stakes)
- **Outcome:** validateSuggestionRange implemented, GitHub API start_line parameter wired

**FR-3.2: Deletion Handling** ‚úÖ SHIPPED
- **Description:** Prevent suggestions spanning deleted lines
- **Acceptance Criteria:**
  - Given diff with deletions
  - When validating suggestion line range
  - Then confirms all lines exist on RIGHT side only
  - And rejects suggestions spanning LEFT-side deletions
- **Priority:** CRITICAL (critical failure mode)
- **Outcome:** isDeletionOnlyFile utility + isRangeWithinSingleHunk validation integrated

**FR-3.3: Multi-Line Escaping** ‚úÖ SHIPPED
- **Description:** Handle backtick conflicts in multi-line suggestions
- **Acceptance Criteria:**
  - Given multi-line suggestion with embedded backticks
  - When formatter escapes content
  - Then applies escaping rules to all lines
  - And delimiter count exceeds max backticks in content
- **Priority:** HIGH (rendering correctness)
- **Outcome:** Phase 1 formatSuggestionBlock handles multi-line automatically

### Phase 4: Validation and Quality

**FR-4.1: Syntax Validation** ‚úÖ SHIPPED
- **Description:** Validate suggested fixes are syntactically correct
- **Acceptance Criteria:**
  - Given suggestion for a code file
  - When validating before posting
  - Then parses with tree-sitter for target language
  - And rejects suggestions causing parse errors
- **Priority:** MEDIUM (quality improvement)
- **Outcome:** validateSyntax with tree-sitter ERROR/MISSING node detection implemented

**FR-4.2: Multi-Provider Consensus Fixes** ‚úÖ SHIPPED
- **Description:** Require consensus for critical severity fixes
- **Acceptance Criteria:**
  - Given critical finding with suggestions from multiple providers
  - When synthesizing final suggestion
  - Then requires minimum agreement threshold (configurable)
  - And selects consensus fix or falls back to description-only
- **Priority:** MEDIUM (differentiator)
- **Outcome:** areASTsEquivalent AST comparator implemented, hasConsensus flag wired into pipeline

**FR-4.3: Context-Aware Fixes** ‚úÖ SHIPPED
- **Description:** Leverage AST and code graph for smarter suggestions
- **Acceptance Criteria:**
  - Given finding in function with dependencies
  - When building LLM prompt
  - Then includes relevant call context from existing code graph
  - And provides project-specific guidelines if available
- **Priority:** LOW (enhancement)
- **Outcome:** PromptEnricher wired, getCallContext available (CodeGraph injection deferred as tech debt)

**FR-4.4: Learning from Feedback** ‚úÖ SHIPPED
- **Description:** Track dismissed suggestions to improve quality
- **Acceptance Criteria:**
  - Given suggestion with üëé reaction in GitHub
  - When learning system processes feedback
  - Then records provider + suggestion + dismissal reason
  - And influences future fix generation (via existing learning system)
- **Priority:** LOW (continuous improvement)
- **Outcome:** Bi-directional learning complete - AcceptanceDetector (üëç) + FeedbackFilter (üëé) both feed ProviderWeightTracker

## Non-Functional Requirements

### NFR-1: Performance

**NFR-1.1: Review Time Impact** ‚úÖ SHIPPED
- **Description:** Fix generation should not significantly increase review time
- **Acceptance Criteria:**
  - Given PR review with 50 findings
  - When generating suggestions
  - Then review completes within 120% of current baseline
- **Priority:** HIGH
- **Outcome:** Single-pass generation with token-aware skipping maintains performance

**NFR-1.2: Token Budget Enforcement** ‚úÖ SHIPPED
- **Description:** Respect existing cost tracking and budget limits
- **Acceptance Criteria:**
  - Given configured budget limit
  - When fix generation increases token usage
  - Then CostTracker enforces limits as currently designed
  - And gracefully degrades (no suggestions) when budget exceeded
- **Priority:** MEDIUM
- **Outcome:** shouldSkipSuggestions respects token limits, graceful degradation preserves findings

### NFR-2: Compatibility

**NFR-2.1: Provider Compatibility** ‚úÖ SHIPPED
- **Description:** Work with all existing LLM providers
- **Acceptance Criteria:**
  - Given any configured provider (Claude, Gemini, OpenRouter, OpenCode, Codex)
  - When requesting fix suggestions
  - Then provider returns suggestions in parseable format
  - And parser handles provider-specific variations
- **Priority:** CRITICAL
- **Outcome:** Uniform prompts across all 5 providers, parser validates suggestions consistently

**NFR-2.2: Existing Workflow Preservation** ‚úÖ SHIPPED
- **Description:** Do not break current review functionality
- **Acceptance Criteria:**
  - Given existing review configuration without suggestions enabled
  - When running review
  - Then all current features work identically
  - And no schema-breaking changes to Finding type
- **Priority:** CRITICAL
- **Outcome:** Finding.suggestion is optional, backward compatible

### NFR-3: Quality and Safety

**NFR-3.1: User Review Enforcement** ‚úÖ SHIPPED
- **Description:** Prevent auto-commit without user review
- **Acceptance Criteria:**
  - Given any suggestion posted
  - When user interacts
  - Then commit requires explicit click action
  - And warnings indicate review necessity ("‚ö†Ô∏è Review before applying")
- **Priority:** CRITICAL (security)
- **Outcome:** GitHub's native suggestion UI enforces explicit user action

**NFR-3.2: Error Handling** ‚úÖ SHIPPED
- **Description:** Handle suggestion failures gracefully
- **Acceptance Criteria:**
  - Given any suggestion generation/formatting error
  - When error occurs
  - Then logs error with context (file, line, provider)
  - And falls back to description-only finding
  - And does NOT crash review process
- **Priority:** HIGH
- **Outcome:** Graceful degradation throughout pipeline, debug-level logging for normal failures

## Out of Scope

These items are explicitly excluded from v0.5:

- **Custom commit UI:** Use GitHub's native suggestion feature (no custom rendering)
- **Automatic fix application:** No auto-commit without user review (security violation)
- **Semantic fix validation:** Beyond syntax checking (requires extensive test framework)
- **Core orchestration changes:** Build on existing pipeline without rewrites
- **New providers:** Focus on suggestion feature, not provider expansion
- **Security-focused auto-fixes:** Requires high trust framework (defer to v2+)
- **Test-coverage-aware suggestions:** Complex integration (defer to v2+)
- **Batch optimization suggestions:** Low ROI initially (defer to v2+)

## Traceability

| Requirement | Source | Phase | Status |
|-------------|--------|-------|--------|
| FR-1.1 | PROJECT.md Active #4, SUMMARY.md Table Stakes | 1 | ‚úÖ SHIPPED |
| FR-1.2 | SUMMARY.md Pitfall #3 | 1 | ‚úÖ SHIPPED |
| FR-1.3 | SUMMARY.md Pitfall #1 | 1 | ‚úÖ SHIPPED |
| FR-2.1 | PROJECT.md Active #1, SUMMARY.md Phase 2 | 2 | ‚úÖ SHIPPED |
| FR-2.2 | PROJECT.md Active #2, SUMMARY.md Phase 2 | 2 | ‚úÖ SHIPPED |
| FR-2.3 | PROJECT.md Active #6, Key Decisions | 2 | ‚úÖ SHIPPED |
| FR-2.4 | SUMMARY.md Pitfall #2 | 2 | ‚úÖ SHIPPED |
| FR-3.1 | PROJECT.md Active #5, SUMMARY.md Table Stakes | 3 | ‚úÖ SHIPPED |
| FR-3.2 | SUMMARY.md Pitfall #5 | 3 | ‚úÖ SHIPPED |
| FR-3.3 | SUMMARY.md Phase 3 | 3 | ‚úÖ SHIPPED |
| FR-4.1 | SUMMARY.md Phase 4 | 4 | ‚úÖ SHIPPED |
| FR-4.2 | SUMMARY.md Differentiators | 4 | ‚úÖ SHIPPED |
| FR-4.3 | SUMMARY.md Differentiators | 4 | ‚úÖ SHIPPED |
| FR-4.4 | SUMMARY.md Differentiators | 4+5 | ‚úÖ SHIPPED |

---

## Milestone Summary

**Shipped:** 14/14 functional requirements (100%)
**Shipped:** 6/6 non-functional requirements (100%)

**Requirements that changed during implementation:**
- None - all requirements implemented as specified

**Requirements dropped:**
- None - all planned requirements shipped

**Technical debt accepted:**
- CodeGraph injection deferred (architectural limitation - requires FileChange[] only available during orchestration)
- Human UI verification pending (code correct, real PR test needed)

---

_Archived: 2026-02-05 as part of v0.5 milestone completion_
