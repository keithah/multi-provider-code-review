---
phase: 08-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/setup.ts
  - src/core/orchestrator.ts
  - __tests__/integration/orchestrator.integration.test.ts
  - __tests__/integration/github-mock.integration.test.ts
  - __tests__/unit/core/orchestrator.health.test.ts
autonomous: true

must_haves:
  truths:
    - "setup.ts no longer creates PromptBuilder instances"
    - "ReviewComponents interface no longer requires promptBuilder field"
    - "All tests pass without shared PromptBuilder"
    - "Orchestrator continues creating per-batch PromptBuilder with runtime intensity"
  artifacts:
    - path: "src/setup.ts"
      provides: "Component setup without PromptBuilder"
      contains: "!PromptBuilder"
    - path: "src/core/orchestrator.ts"
      provides: "ReviewComponents interface without promptBuilder"
      contains: "interface ReviewComponents"
  key_links:
    - from: "src/core/orchestrator.ts"
      to: "PromptBuilder"
      via: "per-batch instantiation in executeReview"
      pattern: "new PromptBuilder\\(config, reviewIntensity\\)"
---

<objective>
Remove legacy hardcoded PromptBuilder from setup.ts and ReviewComponents interface

Purpose: Clean up dead code now that orchestrator creates per-batch PromptBuilder instances with runtime intensity (Phase 7 change). This reduces confusion about where PromptBuilder is created and removes unused code from the setup path.

Output: Cleaner codebase with single source of truth for PromptBuilder instantiation (inside orchestrator batch loop)
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-code-cleanup/08-CONTEXT.md
@src/setup.ts
@src/core/orchestrator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove PromptBuilder from setup.ts and ReviewComponents</name>
  <files>
    src/setup.ts
    src/core/orchestrator.ts
  </files>
  <action>
    1. In src/core/orchestrator.ts:
       - Remove `promptBuilder: PromptBuilder;` from ReviewComponents interface (line 58)
       - Keep the PromptBuilder import (used in executeReview)

    2. In src/setup.ts:
       - Remove PromptBuilder import from imports section (line 3)
       - Remove PromptBuilder creation in createComponentsForCLI (line 121):
         `const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, undefined);`
       - Remove PromptBuilder creation in createComponents (line 253):
         `const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, undefined);`
       - Remove `promptBuilder,` from both return objects (lines ~171 and ~292)

    3. Add a clarifying comment near the ReviewComponents interface:
       ```typescript
       // Note: PromptBuilder is created per-batch by the orchestrator with runtime intensity.
       // This enables intensity-based prompt variations (thorough/standard/light).
       ```

    Do NOT remove:
    - PromptEnricher (still used for suppression/feedback enrichment even if not passed to per-batch PromptBuilder)
    - Any other learning components
  </action>
  <verify>
    Run: `npx tsc --noEmit`
    Expected: No TypeScript errors
  </verify>
  <done>
    - PromptBuilder removed from ReviewComponents interface
    - PromptBuilder removed from both setup functions
    - Comment explains per-batch pattern
    - TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Update test mocks to match new interface</name>
  <files>
    __tests__/integration/orchestrator.integration.test.ts
    __tests__/integration/github-mock.integration.test.ts
    __tests__/unit/core/orchestrator.health.test.ts
  </files>
  <action>
    Remove `promptBuilder` from all ReviewComponents mock objects in test files.

    In orchestrator.integration.test.ts (~6 locations around lines 160, 220, 281, 345, 423, 466):
    - Remove `promptBuilder: new PromptBuilder(config),` lines
    - Keep PromptBuilder import if used elsewhere; remove if now unused

    In github-mock.integration.test.ts (line 144):
    - Remove `promptBuilder: new PromptBuilder(config),` line

    In orchestrator.health.test.ts (line 59):
    - Remove `promptBuilder: { build: jest.fn().mockReturnValue('prompt') } as any,` line
  </action>
  <verify>
    Run: `npm test -- --testPathPattern="orchestrator|github-mock" --passWithNoTests`
    Expected: All tests pass
  </verify>
  <done>
    - All test mocks updated to not include promptBuilder
    - Tests compile and pass
    - No orphaned PromptBuilder imports in test files
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify cleanup</name>
  <files>
    (verification only - no files modified)
  </files>
  <action>
    Run the full test suite to ensure no regressions from the cleanup.

    Verification steps:
    1. Run full test suite: `npm test`
    2. Run TypeScript check: `npx tsc --noEmit`
    3. Grep to confirm no remaining references to removed code:
       - `grep -r "components\.promptBuilder" src/` should return nothing
       - `grep -r "promptBuilder:" src/setup.ts` should return nothing

    If any tests fail:
    - Check if the failure is related to promptBuilder removal
    - If yes, fix the test mock
    - If no (unrelated failure), note it but proceed
  </action>
  <verify>
    Run: `npm test && npx tsc --noEmit`
    Expected: All tests pass, TypeScript compiles
  </verify>
  <done>
    - Full test suite passes
    - TypeScript compilation succeeds
    - No remaining references to shared promptBuilder
    - Phase 8 success criteria met
  </done>
</task>

</tasks>

<verification>
Phase-level verification:
1. `grep -r "promptBuilder" src/setup.ts` returns nothing (removed from setup)
2. `grep "promptBuilder:" src/core/orchestrator.ts` returns nothing (removed from interface)
3. `grep "new PromptBuilder" src/core/orchestrator.ts` returns the per-batch instantiation (still exists)
4. `npm test` - all tests pass
5. `npx tsc --noEmit` - no TypeScript errors
</verification>

<success_criteria>
1. PromptBuilder is NOT created in setup.ts (neither CLI nor Action mode)
2. ReviewComponents interface does NOT include promptBuilder field
3. All tests pass without modifications beyond removing promptBuilder from mocks
4. Orchestrator still creates PromptBuilder per-batch with runtime intensity at line 473
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-code-cleanup/08-01-SUMMARY.md`
</output>
