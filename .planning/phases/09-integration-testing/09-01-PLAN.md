---
phase: 09-integration-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/integration/intensity.integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Integration test proves thorough intensity uses 8 providers, 180000ms timeout, and COMPREHENSIVE prompt"
    - "Integration test proves light intensity uses 3 providers, 60000ms timeout, and QUICK scan prompt"
    - "Integration test proves consensus thresholds vary by intensity (80/60/40%)"
    - "Integration test proves severity filtering varies by intensity (minor/minor/major)"
    - "Integration test proves overlapping path patterns resolve to highest intensity"
    - "Integration test proves files with no pattern match use default fallback intensity"
  artifacts:
    - path: "__tests__/integration/intensity.integration.test.ts"
      provides: "End-to-end intensity behavior validation"
      exports: []
  key_links:
    - from: "__tests__/integration/intensity.integration.test.ts"
      to: "src/core/orchestrator.ts"
      via: "ReviewOrchestrator.executeReview()"
      pattern: "orchestrator\\.executeReview"
    - from: "__tests__/integration/intensity.integration.test.ts"
      to: "src/analysis/path-matcher.ts"
      via: "PathMatcher.determineIntensity()"
      pattern: "determineIntensity"
---

<objective>
Create end-to-end integration tests that prove path-based intensity controls the full review pipeline behavior.

Purpose: Validate that intensity settings (thorough/standard/light) correctly affect provider count, timeout, prompt generation, consensus thresholds, and severity filtering through the actual orchestrator execution path.

Output: `__tests__/integration/intensity.integration.test.ts` with comprehensive integration test coverage for TEST-01 through TEST-06.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-testing/09-CONTEXT.md
@.planning/phases/09-integration-testing/09-RESEARCH.md
@__tests__/integration/orchestrator.integration.test.ts
@__tests__/unit/core/intensity.test.ts
@__tests__/helpers/github-mock.ts
@src/core/orchestrator.ts
@src/config/defaults.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SpyLLMExecutor and intensity integration test file</name>
  <files>__tests__/integration/intensity.integration.test.ts</files>
  <action>
Create a new integration test file with:

1. **SpyLLMExecutor class** that captures execution parameters:
   - Records providers passed to execute()
   - Records timeout passed to execute()
   - Returns canned responses (use FakeProvider pattern from orchestrator.integration.test.ts)
   - Includes filterHealthyProviders() that returns all providers as healthy
   - Add getters: getProvidersUsed(), getTimeoutUsed(), getPromptUsed()

2. **PromptCapturingLLMExecutor class** variant that also captures prompt content:
   - Same as SpyLLMExecutor but also stores the prompt string
   - Used for verifying prompt depth (COMPREHENSIVE vs QUICK scan)

3. **Test helper function `createIntensityTestComponents()`**:
   - Based on pattern from orchestrator.integration.test.ts
   - Accepts overrides including custom llmExecutor and prLoader
   - Sets pathBasedIntensity: true in config
   - Returns ReviewComponents with all required dependencies

4. **Test helper `createPRLoaderWithFiles(files: FileChange[])`**:
   - Returns StubPRLoader that loads a PR with specified files
   - Use createMockFileChange from github-mock.ts for file creation

5. **First describe block: "Intensity: thorough"** with tests:
   - Test "uses 8 providers" - PR with src/auth/login.ts triggers thorough
   - Test "uses 180000ms timeout" - verify intensityTimeout applied
   - Test "generates COMPREHENSIVE prompt" - verify prompt contains "COMPREHENSIVE" and "edge case"

6. **Second describe block: "Intensity: light"** with tests:
   - Test "uses 3 providers" - PR with only test files triggers light
   - Test "uses 60000ms timeout" - verify short timeout
   - Test "generates QUICK scan prompt" - verify prompt contains "QUICK scan" and "CRITICAL issues"

Import from existing helpers:
- createMockFileChange, createMockPRContext from __tests__/helpers/github-mock.ts
- DEFAULT_CONFIG from src/config/defaults.ts
- All component classes needed for ReviewComponents
  </action>
  <verify>
Run `npm test -- __tests__/integration/intensity.integration.test.ts --testPathPattern="Intensity"` and verify:
- 6 tests pass (3 for thorough, 3 for light)
- SpyLLMExecutor correctly captures provider count and timeout
- PromptCapturingLLMExecutor captures prompt content
  </verify>
  <done>
Intensity tests for thorough and light modes pass, proving provider count (8/3), timeout (180000/60000), and prompt depth (COMPREHENSIVE/QUICK) vary by intensity.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add consensus threshold and severity filtering tests</name>
  <files>__tests__/integration/intensity.integration.test.ts</files>
  <action>
Extend the integration test file with consensus and severity tests:

1. **Third describe block: "Consensus thresholds by intensity"** with tests:
   - Create a MultiProviderSpyLLMExecutor that simulates multiple providers returning findings
   - Test "thorough requires 80% consensus (4 of 5 providers)"
     - 5 providers, 3 agree on finding -> filtered out (60% < 80%)
     - 5 providers, 4 agree on finding -> kept (80% >= 80%)
   - Test "standard requires 60% consensus (3 of 5 providers)"
     - 5 providers, 2 agree -> filtered out (40% < 60%)
     - 5 providers, 3 agree -> kept (60% >= 60%)
   - Test "light requires 40% consensus (2 of 5 providers)"
     - 5 providers, 1 agrees -> filtered out (20% < 40%)
     - 5 providers, 2 agree -> kept (40% >= 40%)

2. **Fourth describe block: "Severity filtering by intensity"** with tests:
   - Test "thorough shows minor severity findings"
     - PR with auth files (thorough), minor severity finding -> shown in inlineComments
   - Test "light filters minor severity findings"
     - PR with test files (light), minor severity finding -> filtered out
     - Same PR, major severity finding -> shown in inlineComments
   - Test "standard shows minor severity findings"
     - PR with regular src files (standard), minor severity finding -> shown

3. Use existing ConsensusEngine patterns but verify orchestrator creates correct engine based on intensity.

Key insight from orchestrator.ts (lines 577-598): The orchestrator creates a new ConsensusEngine per review with intensity-specific minAgreement and minSeverity. Your tests should verify this wiring works end-to-end.
  </action>
  <verify>
Run `npm test -- __tests__/integration/intensity.integration.test.ts --testPathPattern="Consensus|Severity"` and verify:
- 6+ tests pass for consensus thresholds
- 3+ tests pass for severity filtering
- Tests prove intensity affects actual filtering behavior
  </verify>
  <done>
Consensus threshold tests prove 80/60/40% thresholds by intensity. Severity filter tests prove thorough/standard show minor, light filters to major+.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add path precedence and fallback tests</name>
  <files>__tests__/integration/intensity.integration.test.ts</files>
  <action>
Complete the integration test file with precedence and fallback tests:

1. **Fifth describe block: "Path pattern precedence"** with tests:
   - Test "overlapping patterns resolve to highest intensity"
     - File `src/auth/login.test.ts` matches both auth/** (thorough) and *.test.ts (light)
     - Verify intensity is thorough (highest wins)
   - Test "mixed file set uses highest matched intensity"
     - Files: [src/auth/login.ts (thorough), src/utils.ts (standard), app.test.ts (light)]
     - Verify overall intensity is thorough
   - Test "single match determines intensity"
     - File `terraform/main.tf` matches only terraform/** (thorough)
     - Verify intensity is thorough

2. **Sixth describe block: "Default fallback intensity"** with tests:
   - Test "files with no pattern match use default intensity"
     - Files: [random/file.xyz, another/unknown.abc]
     - No patterns match -> uses pathDefaultIntensity (standard)
   - Test "custom default intensity is respected"
     - Config with pathDefaultIntensity: 'light'
     - Non-matching files use light intensity

3. Each test should verify through SpyLLMExecutor that the correct provider count and timeout were used (indirect proof of intensity).

4. Add a test that logs the intensity decision reason (from PathMatcher.determineIntensity().reason) to help debugging.
  </action>
  <verify>
Run `npm test -- __tests__/integration/intensity.integration.test.ts` and verify:
- All tests pass (should be 15+ tests total)
- Path precedence correctly resolves overlapping patterns
- Default fallback works for unmatched files
  </verify>
  <done>
All 6 success criteria (TEST-01 through TEST-06) are covered by passing integration tests. The test file proves end-to-end that intensity affects provider count, timeout, prompt depth, consensus thresholds, severity filtering, path precedence, and default fallback.
  </done>
</task>

</tasks>

<verification>
Run the full integration test suite:
```bash
npm test -- __tests__/integration/intensity.integration.test.ts
```

Expected: All tests pass with no failures.

Verify coverage of all 6 requirements:
- TEST-01: thorough uses 8 providers, 180000ms timeout, detailed prompts
- TEST-02: light uses 3 providers, 60000ms timeout, brief prompts
- TEST-03: consensus thresholds vary (80/60/40%)
- TEST-04: severity filtering varies (minor/minor/major)
- TEST-05: overlapping patterns tested with precedence
- TEST-06: no-match files use default fallback
</verification>

<success_criteria>
- `__tests__/integration/intensity.integration.test.ts` exists with 15+ tests
- All tests pass when run with `npm test`
- Tests use real component code (not just mocks) to validate integration
- SpyLLMExecutor pattern captures and verifies execution parameters
- Path precedence tests prove highest intensity wins
- Default fallback tests prove pathDefaultIntensity is respected
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-testing/09-01-SUMMARY.md`
</output>
