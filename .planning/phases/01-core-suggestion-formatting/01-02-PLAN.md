---
phase: 01-core-suggestion-formatting
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/utils/suggestion-validator.ts
  - src/utils/suggestion-validator.test.ts
autonomous: true

must_haves:
  truths:
    - "validateSuggestionLine() returns position when line exists in diff"
    - "validateSuggestionLine() returns null when line is not in diff"
    - "isSuggestionLineValid() provides boolean convenience wrapper"
  artifacts:
    - path: "src/utils/suggestion-validator.ts"
      provides: "Line validation for suggestions"
      exports: ["validateSuggestionLine", "isSuggestionLineValid"]
      min_lines: 30
    - path: "src/utils/suggestion-validator.test.ts"
      provides: "Unit tests for suggestion validator"
      contains: "describe('validateSuggestionLine'"
      min_lines: 50
  key_links:
    - from: "src/utils/suggestion-validator.ts"
      to: "src/utils/diff.ts"
      via: "mapLinesToPositions import"
      pattern: "import.*mapLinesToPositions.*from"
---

<objective>
Create the suggestion line validator using TDD.

Purpose: Before formatting a suggestion, we must validate that the target line exists in the diff (RIGHT side only). This prevents GitHub API errors and ensures suggestions appear at correct positions.

Output: A tested `suggestion-validator.ts` module that integrates with existing diff utilities.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-suggestion-formatting/01-RESEARCH.md
@src/utils/diff.ts
</context>

<feature>
  <name>Suggestion Line Validator</name>
  <files>src/utils/suggestion-validator.ts, src/utils/suggestion-validator.test.ts</files>
  <behavior>
    validateSuggestionLine(lineNumber: number, patch: string | undefined) -> number | null

    Returns diff position if line exists in patch (RIGHT side), null otherwise.

    Cases (using sample patch):
    ```
    @@ -1,3 +1,4 @@
     context line
    +added line
     more context
    +another added
    ```
    - validateSuggestionLine(1, patch) -> 2 (context line at position 2)
    - validateSuggestionLine(2, patch) -> 3 (added line at position 3)
    - validateSuggestionLine(3, patch) -> 4 (more context at position 4)
    - validateSuggestionLine(4, patch) -> 5 (another added at position 5)
    - validateSuggestionLine(100, patch) -> null (line not in diff)
    - validateSuggestionLine(1, undefined) -> null (no patch)
    - validateSuggestionLine(1, "") -> null (empty patch)

    isSuggestionLineValid(lineNumber: number, patch: string | undefined) -> boolean
    - Convenience wrapper: returns true if validateSuggestionLine returns non-null
  </behavior>
  <implementation>
    1. Import mapLinesToPositions from '../utils/diff'
    2. validateSuggestionLine():
       - Call mapLinesToPositions(patch) to get Map<lineNumber, position>
       - Return map.get(lineNumber) ?? null
    3. isSuggestionLineValid():
       - Return validateSuggestionLine(lineNumber, patch) !== null
  </implementation>
</feature>

<verification>
- Run `npm test -- --grep "suggestion-validator"` - all tests pass
- Verify test file covers: valid line in diff, line not in diff, undefined patch, empty patch, edge cases
- Verify integration with existing mapLinesToPositions works correctly
</verification>

<success_criteria>
- Test file exists with at least 5 test cases
- All tests pass
- Functions correctly integrate with mapLinesToPositions from diff.ts
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-suggestion-formatting/01-02-SUMMARY.md`
</output>
