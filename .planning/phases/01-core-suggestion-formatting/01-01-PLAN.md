---
phase: 01-core-suggestion-formatting
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/utils/suggestion-formatter.ts
  - src/utils/suggestion-formatter.test.ts
autonomous: true

must_haves:
  truths:
    - "formatSuggestionBlock() produces valid GitHub suggestion markdown"
    - "Backticks in suggestion content do not break markdown rendering"
    - "Empty or whitespace-only suggestions return empty string (no block)"
  artifacts:
    - path: "src/utils/suggestion-formatter.ts"
      provides: "Suggestion formatting utilities"
      exports: ["formatSuggestionBlock", "countMaxConsecutiveBackticks"]
      min_lines: 40
    - path: "src/utils/suggestion-formatter.test.ts"
      provides: "Unit tests for suggestion formatter"
      contains: "describe('formatSuggestionBlock'"
      min_lines: 60
  key_links:
    - from: "src/utils/suggestion-formatter.ts"
      to: "GitHub suggestion syntax"
      via: "```suggestion fence delimiter"
      pattern: "suggestion\\n"
---

<objective>
Create the core suggestion formatting utility using TDD.

Purpose: This utility converts raw suggestion text into GitHub's native suggestion block format, handling backtick escaping to prevent markdown conflicts. This is the foundation that all suggestion rendering depends on.

Output: A tested `suggestion-formatter.ts` module with pure functions for formatting and escaping.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-suggestion-formatting/01-RESEARCH.md
</context>

<feature>
  <name>Suggestion Block Formatter</name>
  <files>src/utils/suggestion-formatter.ts, src/utils/suggestion-formatter.test.ts</files>
  <behavior>
    formatSuggestionBlock(content: string) -> string

    Cases:
    - "const x = 1;" -> "```suggestion\nconst x = 1;\n```"
    - "const x = `template`;" -> "```suggestion\nconst x = `template`;\n```" (single backtick - 3 delimiter is safe)
    - "```typescript\ncode\n```" -> "````suggestion\n```typescript\ncode\n```\n````" (triple backtick - needs 4)
    - "" -> "" (empty input returns empty)
    - "   " -> "" (whitespace-only returns empty)
    - "````nested````" -> "`````suggestion\n````nested````\n`````" (4 backticks - needs 5)

    countMaxConsecutiveBackticks(str: string) -> number
    - "hello" -> 0
    - "`x`" -> 1
    - "```code```" -> 3
    - "````deep````" -> 4
  </behavior>
  <implementation>
    1. Create countMaxConsecutiveBackticks() using regex /`+/g to find all backtick sequences
    2. Return max length of matched sequences (0 if none)
    3. Create formatSuggestionBlock():
       - Return empty string for empty/whitespace-only input
       - Count max backticks in content
       - Compute delimiter count as max(3, maxBackticks + 1)
       - Return: delimiter + "suggestion\n" + content + "\n" + delimiter
  </implementation>
</feature>

<verification>
- Run `npm test -- --grep "suggestion-formatter"` - all tests pass
- Verify test file has coverage for: normal content, single backticks, triple backticks, 4+ backticks, empty input, whitespace input
- Verify exports are correct: `import { formatSuggestionBlock, countMaxConsecutiveBackticks } from '../utils/suggestion-formatter'` compiles
</verification>

<success_criteria>
- Test file exists with at least 6 test cases covering all edge cases in behavior spec
- All tests pass
- Functions are exported and importable
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-suggestion-formatting/01-01-SUMMARY.md`
</output>
