---
phase: 01-core-suggestion-formatting
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/output/formatter.ts
  - src/output/formatter-v2.ts
  - src/github/comment-poster.ts
autonomous: true

must_haves:
  truths:
    - "Inline comments with Finding.suggestion include GitHub commit suggestion blocks"
    - "Suggestions render with 'Commit suggestion' button in GitHub UI"
    - "Invalid suggestion lines are rejected with warning log (finding still posts without suggestion)"
  artifacts:
    - path: "src/output/formatter.ts"
      provides: "MarkdownFormatter with suggestion block support"
      contains: "formatSuggestionBlock"
    - path: "src/output/formatter-v2.ts"
      provides: "MarkdownFormatterV2 with suggestion block support"
      contains: "formatSuggestionBlock"
    - path: "src/github/comment-poster.ts"
      provides: "CommentPoster with suggestion validation"
      contains: "validateSuggestionLine"
  key_links:
    - from: "src/output/formatter.ts"
      to: "src/utils/suggestion-formatter.ts"
      via: "import formatSuggestionBlock"
      pattern: "import.*formatSuggestionBlock"
    - from: "src/github/comment-poster.ts"
      to: "src/utils/suggestion-validator.ts"
      via: "import validateSuggestionLine"
      pattern: "import.*validateSuggestionLine"
---

<objective>
Integrate suggestion formatting into the output pipeline.

Purpose: Connect the formatter and validator utilities to the existing output flow so that findings with suggestions render as commit-suggestion blocks in GitHub PR comments.

Output: Updated formatters and comment poster that produce GitHub suggestion syntax.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-suggestion-formatting/01-RESEARCH.md
@src/output/formatter.ts
@src/output/formatter-v2.ts
@src/github/comment-poster.ts
@src/utils/diff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MarkdownFormatter to use suggestion blocks</name>
  <files>src/output/formatter.ts</files>
  <action>
    1. Add import at top: `import { formatSuggestionBlock } from '../utils/suggestion-formatter';`

    2. Modify printSeveritySection() method. Change this section (around lines 96-107):
       ```typescript
       if (f.suggestion) {
         lines.push(`  Suggestion: ${f.suggestion}`);
       }
       ```
       To:
       ```typescript
       if (f.suggestion) {
         const suggestionBlock = formatSuggestionBlock(f.suggestion);
         if (suggestionBlock) {
           lines.push('');
           lines.push('  **Suggested fix:**');
           lines.push(suggestionBlock);
         }
       }
       ```

    Why: The current formatter shows suggestions as plain text. We need to render them as GitHub suggestion blocks so users see the "Commit suggestion" button.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>MarkdownFormatter imports formatSuggestionBlock and uses it for findings with suggestions</done>
</task>

<task type="auto">
  <name>Task 2: Update MarkdownFormatterV2 to use suggestion blocks</name>
  <files>src/output/formatter-v2.ts</files>
  <action>
    1. Add import at top: `import { formatSuggestionBlock } from '../utils/suggestion-formatter';`

    2. Modify formatFinding() method. Replace the suggestion handling section (around lines 242-256):
       ```typescript
       if (finding.suggestion) {
         lines.push('**Suggested Fix:**');
         const trimmedSuggestion = finding.suggestion.trim();
         // Check if suggestion is already fenced
         if (trimmedSuggestion.startsWith('```')) {
           // Already fenced, use as-is
           lines.push(trimmedSuggestion);
         } else {
           // Not fenced, wrap it
           lines.push('```');
           lines.push(trimmedSuggestion);
           lines.push('```');
         }
         lines.push('');
       }
       ```
       With:
       ```typescript
       if (finding.suggestion) {
         const suggestionBlock = formatSuggestionBlock(finding.suggestion);
         if (suggestionBlock) {
           lines.push('**Suggested Fix:**');
           lines.push('');
           lines.push(suggestionBlock);
           lines.push('');
         }
       }
       ```

    Why: The v2 formatter has manual backtick handling that can conflict with nested code. The formatSuggestionBlock utility handles all escaping correctly.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>MarkdownFormatterV2 imports formatSuggestionBlock and produces proper suggestion blocks</done>
</task>

<task type="auto">
  <name>Task 3: Add suggestion validation to CommentPoster</name>
  <files>src/github/comment-poster.ts</files>
  <action>
    1. Add import at top: `import { isSuggestionLineValid } from '../utils/suggestion-validator';`

    2. In postInline() method, after the position validation (around line 165-171), add validation for suggestions. Find this block:
       ```typescript
       if (!position) {
         logger.warn(`Cannot find diff position for ${c.path}:${c.line}, skipping inline comment`);
         return null;
       }
       ```

    3. After that block, add suggestion validation:
       ```typescript
       // Validate suggestions can be applied at this line
       if (c.body.includes('```suggestion')) {
         const file = files.find(f => f.filename === c.path);
         if (!file || !isSuggestionLineValid(c.line, file.patch)) {
           // Line isn't in diff - strip suggestion block but keep the finding
           logger.warn(`Suggestion line ${c.path}:${c.line} not valid in diff, posting without suggestion block`);
           c.body = c.body.replace(/```suggestion[\s\S]*?```/g, '_Suggestion not available for this line_');
         }
       }
       ```

    Why: Even if a position exists for context lines, suggestions should only apply to RIGHT-side lines (added/modified). This validation catches edge cases where the position exists but suggestion would fail.

    Note: The suggestion block regex replacement ensures the finding still gets posted (graceful degradation per FR-2.3 preparation).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CommentPoster validates suggestion lines and gracefully degrades when invalid</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- `npm test` passes (no regressions)
- Grep for imports: `grep -r "formatSuggestionBlock" src/output/` shows both formatters
- Grep for validation: `grep "isSuggestionLineValid" src/github/comment-poster.ts` shows import and usage
</verification>

<success_criteria>
- Both formatters use formatSuggestionBlock for suggestions
- CommentPoster validates suggestion lines before posting
- All existing tests pass
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-suggestion-formatting/01-03-SUMMARY.md`
</output>
