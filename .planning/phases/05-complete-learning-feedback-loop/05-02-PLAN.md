---
phase: 05-complete-learning-feedback-loop
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/core/orchestrator.ts
autonomous: true

must_haves:
  truths:
    - "Orchestrator detects acceptances from PR commits during review execution"
    - "Orchestrator detects acceptances from comment reactions during review execution"
    - "Detected acceptances are recorded to ProviderWeightTracker"
    - "Acceptance detection failures do not block review posting"
  artifacts:
    - path: "src/core/orchestrator.ts"
      provides: "detectAndRecordAcceptances private method"
      contains: "detectAndRecordAcceptances"
    - path: "src/core/orchestrator.ts"
      provides: "Acceptance detection call in executeReview"
      contains: "this.detectAndRecordAcceptances"
  key_links:
    - from: "src/core/orchestrator.ts"
      to: "AcceptanceDetector.detectFromCommits"
      via: "method call in detectAndRecordAcceptances"
      pattern: "acceptanceDetector\\.detectFromCommits"
    - from: "src/core/orchestrator.ts"
      to: "AcceptanceDetector.recordAcceptances"
      via: "method call in detectAndRecordAcceptances"
      pattern: "acceptanceDetector\\.recordAcceptances"
    - from: "src/core/orchestrator.ts"
      to: "ProviderWeightTracker"
      via: "passed to recordAcceptances"
      pattern: "providerWeightTracker"
---

<objective>
Add acceptance detection orchestration to review execution flow

Purpose: Complete the positive feedback loop by detecting and recording suggestion acceptances during each PR review run. Uses polling approach since GitHub does not provide webhooks for reactions.

Output: Orchestrator detects acceptances from commits and reactions, records them to ProviderWeightTracker for bi-directional learning
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-complete-learning-feedback-loop/05-RESEARCH.md
@.planning/phases/05-complete-learning-feedback-loop/05-01-SUMMARY.md
@src/core/orchestrator.ts
@src/learning/acceptance-detector.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add detectAndRecordAcceptances private method to ReviewOrchestrator</name>
  <files>src/core/orchestrator.ts</files>
  <action>
    Add a private method to detect and record suggestion acceptances. Place it after the dispose() method (around line 738):

    ```typescript
    /**
     * Detect and record suggestion acceptances from PR activity.
     *
     * Checks for:
     * 1. Committed suggestions (via GitHub's "Commit suggestion" button)
     * 2. Thumbs-up reactions on suggestion comments
     *
     * Records acceptances as positive feedback to improve provider weights.
     */
    private async detectAndRecordAcceptances(prNumber: number): Promise<void> {
      const { githubClient, acceptanceDetector, providerWeightTracker } = this.components;
      if (!githubClient || !acceptanceDetector || !providerWeightTracker) return;

      const { octokit, owner, repo } = githubClient;

      // 1. Fetch PR commits
      const commitsResponse = await octokit.rest.pulls.listCommits({
        owner,
        repo,
        pull_number: prNumber,
        per_page: 100,
      });

      const commits = commitsResponse.data.map(commit => ({
        sha: commit.sha,
        message: commit.commit.message,
        files: (commit.files || []).map(f => f.filename),
        timestamp: new Date(commit.commit.author?.date || Date.now()).getTime(),
      }));

      // 2. Fetch review comments
      const comments = await octokit.paginate(octokit.rest.pulls.listReviewComments, {
        owner,
        repo,
        pull_number: prNumber,
        per_page: 100,
      });

      // 3. Build file/line/provider map and fetch reactions
      const commentedFiles = new Map<string, Array<{ line: number; provider?: string }>>();
      const commentReactions: Array<{
        commentId: number;
        file: string;
        line: number;
        provider?: string;
        reactions: Array<{ user: string; content: string }>;
      }> = [];

      for (const comment of comments) {
        const file = comment.path;
        const line = comment.line || comment.original_line || 0;

        // Extract provider from comment body (embedded by CommentPoster)
        const providerMatch = comment.body?.match(/\*\*Provider:\*\* `([^`]+)`/);
        const provider = providerMatch?.[1];

        // Build file map for commit detection
        if (!commentedFiles.has(file)) {
          commentedFiles.set(file, []);
        }
        commentedFiles.get(file)!.push({ line, provider });

        // Fetch reactions for this comment
        const reactions = await octokit.rest.reactions.listForPullRequestReviewComment({
          owner,
          repo,
          comment_id: comment.id,
        });

        commentReactions.push({
          commentId: comment.id,
          file,
          line,
          provider,
          reactions: reactions.data.map(r => ({
            user: r.user?.login || 'unknown',
            content: r.content,
          })),
        });
      }

      // 4. Detect acceptances from both sources
      const commitAcceptances = acceptanceDetector.detectFromCommits(commits, commentedFiles);
      const reactionAcceptances = acceptanceDetector.detectFromReactions(commentReactions);

      // 5. Record all acceptances to weight tracker
      const allAcceptances = [...commitAcceptances, ...reactionAcceptances];
      await acceptanceDetector.recordAcceptances(allAcceptances, providerWeightTracker);

      if (allAcceptances.length > 0) {
        logger.info(
          `Acceptance detection: ${commitAcceptances.length} from commits, ` +
          `${reactionAcceptances.length} from reactions, ${allAcceptances.length} total`
        );
      } else {
        logger.debug('No suggestion acceptances detected');
      }
    }
    ```

    Import types from AcceptanceDetector are already available via the import added in Plan 05-01.
  </action>
  <verify>`grep -n "detectAndRecordAcceptances" src/core/orchestrator.ts` shows method definition</verify>
  <done>detectAndRecordAcceptances method added to ReviewOrchestrator class</done>
</task>

<task type="auto">
  <name>Task 2: Call acceptance detection in executeReview flow</name>
  <files>src/core/orchestrator.ts</files>
  <action>
    Add acceptance detection call in executeReview() after loading suppressed comments. Find line ~696 where feedbackFilter.loadSuppressed is called:

    ```typescript
    const suppressed = await this.components.feedbackFilter.loadSuppressed(pr.number);
    ```

    Add immediately after this line (before the inlineFiltered line):

    ```typescript
    // Detect and record suggestion acceptances (positive feedback)
    if (this.components.acceptanceDetector &&
        this.components.providerWeightTracker &&
        this.components.githubClient) {
      try {
        await this.detectAndRecordAcceptances(pr.number);
      } catch (error) {
        // Don't fail review if acceptance detection fails - it's supplementary
        logger.debug('Failed to detect acceptances', error as Error);
      }
    }
    ```

    Note: Use logger.debug (not warn) per project convention - acceptance detection failure is normal flow (e.g., first review run has no comments to analyze).
  </action>
  <verify>`grep -n "detectAndRecordAcceptances" src/core/orchestrator.ts` shows both method definition and call in executeReview</verify>
  <done>Acceptance detection called during review execution, failures handled gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Verify build and test suite</name>
  <files>src/core/orchestrator.ts</files>
  <action>
    Run the build and test suite to verify the changes:

    1. `npm run build` - TypeScript compilation
    2. `npm test` - Full test suite

    If any tests fail related to orchestrator mocking, update the test mocks to include the new acceptanceDetector field (set to undefined in most test cases since acceptance detection is optional).
  </action>
  <verify>`npm run build && npm test` - both pass</verify>
  <done>Build passes, all tests pass, acceptance detection integrated</done>
</task>

</tasks>

<verification>
1. `npm run build` - TypeScript compiles without errors
2. `npm test` - All existing tests pass
3. `grep -n "detectAndRecordAcceptances" src/core/orchestrator.ts` - Shows method definition and call
4. `grep -n "acceptanceDetector.detectFromCommits\|acceptanceDetector.recordAcceptances" src/core/orchestrator.ts` - Shows AcceptanceDetector integration
</verification>

<success_criteria>
- detectAndRecordAcceptances method fetches commits, comments, and reactions from GitHub API
- Method calls AcceptanceDetector.detectFromCommits() and detectFromReactions()
- Method calls AcceptanceDetector.recordAcceptances() with ProviderWeightTracker
- Acceptance detection called during executeReview() after loadSuppressed()
- Failures wrapped in try-catch with debug logging (no review blocking)
- Build and tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-complete-learning-feedback-loop/05-02-SUMMARY.md`
</output>
