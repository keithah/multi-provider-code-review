---
phase: 05-complete-learning-feedback-loop
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/github/feedback.ts
  - src/setup.ts
  - tests/github/feedback.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Thumbs-down reactions trigger ProviderWeightTracker.recordFeedback('ðŸ‘Ž') calls"
    - "Provider weights decrease when suggestions are dismissed"
    - "Dismissal feedback uses same weight formula as acceptance feedback"
  artifacts:
    - path: "src/github/feedback.ts"
      provides: "FeedbackFilter with providerWeightTracker integration"
      contains: "providerWeightTracker.recordFeedback"
    - path: "tests/github/feedback.test.ts"
      provides: "Test coverage for negative feedback recording"
      contains: "recordFeedback.*ðŸ‘Ž"
  key_links:
    - from: "src/github/feedback.ts"
      to: "ProviderWeightTracker.recordFeedback"
      via: "constructor injection"
      pattern: "this\\.providerWeightTracker\\??\\.recordFeedback"
    - from: "src/setup.ts"
      to: "FeedbackFilter constructor"
      via: "providerWeightTracker argument"
      pattern: "new FeedbackFilter.*providerWeightTracker"
---

<objective>
Close gap: FeedbackFilter detects thumbs-down reactions but does not record negative feedback to ProviderWeightTracker

Purpose: Complete bi-directional learning by wiring dismissal detection to provider weight decreases
Output: FeedbackFilter records negative feedback, completing the weight adjustment loop
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-complete-learning-feedback-loop/05-VERIFICATION.md
@src/github/feedback.ts
@src/setup.ts
@src/learning/provider-weights.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add providerWeightTracker to FeedbackFilter and record negative feedback</name>
  <files>src/github/feedback.ts</files>
  <action>
Modify FeedbackFilter class to accept and use ProviderWeightTracker:

1. Add import at top of file:
   ```typescript
   import { ProviderWeightTracker } from '../learning/provider-weights';
   ```

2. Update constructor to accept optional providerWeightTracker:
   ```typescript
   constructor(
     private readonly client: GitHubClient,
     private readonly providerWeightTracker?: ProviderWeightTracker
   ) {}
   ```

3. In loadSuppressed(), after detecting thumbs-down (inside `if (hasThumbsDown)` block), add provider extraction and feedback recording:
   ```typescript
   if (hasThumbsDown) {
     const signature = this.signatureFromComment(comment.path, comment.line, comment.body || '');
     suppressed.add(signature);

     // Record negative feedback if weight tracker available
     if (this.providerWeightTracker) {
       const providerMatch = comment.body?.match(/\*\*Provider:\*\* `([^`]+)`/);
       const provider = providerMatch?.[1];
       if (provider) {
         await this.providerWeightTracker.recordFeedback(provider, 'ðŸ‘Ž');
       }
     }
   }
   ```

Note: Use the same provider extraction pattern as AcceptanceDetector for consistency.
  </action>
  <verify>TypeScript compiles: `npm run build` completes without errors in feedback.ts</verify>
  <done>FeedbackFilter.loadSuppressed() calls providerWeightTracker.recordFeedback('ðŸ‘Ž') when detecting thumbs-down reactions with provider attribution</done>
</task>

<task type="auto">
  <name>Task 2: Wire providerWeightTracker into FeedbackFilter in setup.ts</name>
  <files>src/setup.ts</files>
  <action>
Update FeedbackFilter instantiation in createComponents() function to pass providerWeightTracker:

1. Find the line (around line 243):
   ```typescript
   const feedbackFilter = new FeedbackFilter(githubClient);
   ```

2. Move this line AFTER providerWeightTracker is created (after line 249), and update to:
   ```typescript
   const feedbackFilter = new FeedbackFilter(githubClient, providerWeightTracker);
   ```

This requires moving the feedbackFilter instantiation down a few lines so providerWeightTracker is available.

Note: CLI mode uses a mock FeedbackFilter (lines 160-166) that doesn't need the tracker since it always returns empty suppression set.
  </action>
  <verify>TypeScript compiles: `npm run build` passes. Verify setup.ts creates FeedbackFilter with providerWeightTracker argument.</verify>
  <done>FeedbackFilter instantiated with providerWeightTracker in production mode, enabling negative feedback recording</done>
</task>

<task type="auto">
  <name>Task 3: Add test coverage for negative feedback recording</name>
  <files>tests/github/feedback.test.ts</files>
  <action>
Add tests verifying FeedbackFilter records negative feedback:

1. Import ProviderWeightTracker:
   ```typescript
   import { ProviderWeightTracker } from '../../src/learning/provider-weights';
   ```

2. Add describe block for weight tracker integration:
   ```typescript
   describe('negative feedback recording', () => {
     it('records negative feedback when comment has thumbs-down and provider', async () => {
       const mockWeightTracker = {
         recordFeedback: jest.fn().mockResolvedValue(undefined),
       } as unknown as ProviderWeightTracker;

       const filter = new FeedbackFilter(mockClient, mockWeightTracker);

       // Mock comment with provider attribution and thumbs-down
       mockOctokit.paginate.mockResolvedValue([
         {
           id: 1,
           path: 'test.ts',
           line: 10,
           body: '**Issue Title**\n\n**Provider:** `claude`',
         },
       ]);
       mockOctokit.rest.reactions.listForPullRequestReviewComment.mockResolvedValue({
         data: [{ content: '-1' }],
       });

       await filter.loadSuppressed(123);

       expect(mockWeightTracker.recordFeedback).toHaveBeenCalledWith('claude', 'ðŸ‘Ž');
     });

     it('does not record feedback when no provider in comment', async () => {
       const mockWeightTracker = {
         recordFeedback: jest.fn().mockResolvedValue(undefined),
       } as unknown as ProviderWeightTracker;

       const filter = new FeedbackFilter(mockClient, mockWeightTracker);

       // Mock comment without provider attribution
       mockOctokit.paginate.mockResolvedValue([
         {
           id: 1,
           path: 'test.ts',
           line: 10,
           body: '**Issue Title**\n\nSome description without provider',
         },
       ]);
       mockOctokit.rest.reactions.listForPullRequestReviewComment.mockResolvedValue({
         data: [{ content: '-1' }],
       });

       await filter.loadSuppressed(123);

       expect(mockWeightTracker.recordFeedback).not.toHaveBeenCalled();
     });

     it('works without weight tracker (backward compatible)', async () => {
       const filter = new FeedbackFilter(mockClient);

       mockOctokit.paginate.mockResolvedValue([
         {
           id: 1,
           path: 'test.ts',
           line: 10,
           body: '**Issue Title**\n\n**Provider:** `claude`',
         },
       ]);
       mockOctokit.rest.reactions.listForPullRequestReviewComment.mockResolvedValue({
         data: [{ content: '-1' }],
       });

       // Should not throw, suppression still works
       const suppressed = await filter.loadSuppressed(123);
       expect(suppressed.size).toBe(1);
     });
   });
   ```

Note: Adapt mocking to existing test setup patterns. If test file doesn't exist, create it with proper imports and basic setup.
  </action>
  <verify>Run tests: `npm test -- --testPathPattern=feedback`. All feedback tests pass including new negative feedback recording tests.</verify>
  <done>Tests verify: (1) thumbs-down with provider triggers recordFeedback('ðŸ‘Ž'), (2) no provider = no feedback call, (3) backward compatible without tracker</done>
</task>

</tasks>

<verification>
Run full verification suite:

```bash
# Build passes
npm run build

# Feedback tests pass
npm test -- --testPathPattern=feedback

# Verify integration
grep -n "recordFeedback.*ðŸ‘Ž" src/github/feedback.ts
grep -n "FeedbackFilter.*providerWeightTracker" src/setup.ts
```
</verification>

<success_criteria>
1. FeedbackFilter constructor accepts optional ProviderWeightTracker
2. loadSuppressed() extracts provider from comment body when detecting thumbs-down
3. loadSuppressed() calls providerWeightTracker.recordFeedback(provider, 'ðŸ‘Ž') for attributed dismissals
4. setup.ts wires providerWeightTracker into FeedbackFilter for production mode
5. All tests pass including new negative feedback recording tests
6. Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-complete-learning-feedback-loop/05-03-SUMMARY.md`
</output>
