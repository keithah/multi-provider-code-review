---
phase: 06-configuration-a-validation
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/config/loader.ts
  - examples/config/intensity-patterns.yml
  - docs/configuration.md
autonomous: true

must_haves:
  truths:
    - "ConfigLoader validates intensity behavior fields at startup"
    - "Invalid consensus percentages are clamped with warning, not rejected"
    - "Invalid severity enums fail with typo suggestions"
    - "Path pattern precedence rules are documented"
    - "Example config files demonstrate intensity patterns"
  artifacts:
    - path: "src/config/loader.ts"
      provides: "Integrated validation for new intensity fields"
      contains: "validateIntensityBehaviors"
    - path: "examples/config/intensity-patterns.yml"
      provides: "Example configuration with intensity patterns"
      contains: "intensity_consensus_thresholds"
    - path: "docs/configuration.md"
      provides: "Documentation for path pattern precedence"
      contains: "precedence"
  key_links:
    - from: "src/config/loader.ts"
      to: "src/config/validators.ts"
      via: "import validation helpers"
      pattern: "import.*validators"
    - from: "src/config/loader.ts"
      to: "src/config/schema.ts"
      via: "schema validation"
      pattern: "ReviewConfigSchema"
---

<objective>
Integrate validation into ConfigLoader and provide documentation/examples.

Purpose: Wire the validation helpers from Plan 02 into ConfigLoader.load(), add normalizeKeys for new fields, and create example configs + documentation for path pattern precedence (CONFIG-03, CONFIG-04).

Output: Working validation at startup, example config file, documentation for precedence rules.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-configuration-a-validation/06-CONTEXT.md
@.planning/phases/06-configuration-a-validation/06-RESEARCH.md
@.planning/phases/06-configuration-a-validation/06-01-SUMMARY.md
@.planning/phases/06-configuration-a-validation/06-02-SUMMARY.md

@src/config/loader.ts
@src/config/validators.ts
@src/config/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate Validators into ConfigLoader</name>
  <files>src/config/loader.ts</files>
  <action>
Update ConfigLoader to:

1. Import validators:
```typescript
import { clampPercentage, validateSeverityWithSuggestion } from './validators';
```

2. Add normalizeKeys entries for new fields (around line 200):
```typescript
intensityConsensusThresholds: config.intensity_consensus_thresholds,
intensitySeverityFilters: config.intensity_severity_filters,
```

3. Add validation method (after existing validateConfig call, around line 36):
```typescript
// Validate intensity behavior fields
this.validateIntensityBehaviors(merged);
```

4. Add the validation method:
```typescript
/**
 * Validate intensity behavior configuration.
 * - Consensus thresholds: clamp to 0-100 with warning
 * - Severity filters: fail with typo suggestions
 */
private static validateIntensityBehaviors(config: ReviewConfig): void {
  // Validate consensus thresholds (clamp with warning)
  if (config.intensityConsensusThresholds) {
    const thresholds = config.intensityConsensusThresholds;
    for (const level of ['thorough', 'standard', 'light'] as const) {
      if (thresholds[level] !== undefined) {
        thresholds[level] = clampPercentage(
          thresholds[level],
          `intensityConsensusThresholds.${level}`
        );
      }
    }
  }

  // Validate severity filters (strict with suggestions)
  if (config.intensitySeverityFilters) {
    const filters = config.intensitySeverityFilters;
    for (const level of ['thorough', 'standard', 'light'] as const) {
      if (filters[level] !== undefined) {
        filters[level] = validateSeverityWithSuggestion(
          filters[level],
          `intensitySeverityFilters.${level}`
        );
      }
    }
  }
}
```

Note: Validation happens AFTER merge, so we validate the final config. This is intentional - we validate what will actually be used.
  </action>
  <verify>Run `npm run build` - compiles without errors. Run `npm test` - all tests pass.</verify>
  <done>ConfigLoader validates intensity behavior fields at startup with correct behavior (clamp vs fail)</done>
</task>

<task type="auto">
  <name>Task 2: Create Example Configuration File</name>
  <files>examples/config/intensity-patterns.yml</files>
  <action>
Create example config file demonstrating intensity patterns (CONFIG-04):

```yaml
# Example: Path-Based Intensity Configuration
#
# This file demonstrates how to configure different review intensities
# based on file path patterns. Use this as a starting point for your
# .github/multi-review.yml configuration.

# Enable path-based intensity (required)
path_based_intensity: true

# Default intensity for files not matching any pattern
path_default_intensity: standard

# Path patterns mapped to intensity levels
# Format: JSON string with array of {pattern, intensity} objects
# Patterns use glob syntax (*, **, ?)
#
# PRECEDENCE RULE: When multiple patterns match, highest intensity wins.
# Order: thorough > standard > light
#
# Examples:
# - src/core/** matches thorough, docs/** matches light
# - If a file matches both, thorough wins
path_intensity_patterns: |
  [
    {"pattern": "src/core/**", "intensity": "thorough"},
    {"pattern": "src/auth/**", "intensity": "thorough"},
    {"pattern": "src/api/**", "intensity": "thorough"},
    {"pattern": "src/**/*.ts", "intensity": "standard"},
    {"pattern": "tests/**", "intensity": "standard"},
    {"pattern": "docs/**", "intensity": "light"},
    {"pattern": "*.md", "intensity": "light"},
    {"pattern": "examples/**", "intensity": "light"}
  ]

# Provider counts per intensity (how many providers to use)
intensity_provider_counts:
  thorough: 8   # Maximum coverage for critical code
  standard: 5   # Balanced coverage
  light: 3      # Quick scan

# Timeout per intensity (milliseconds)
intensity_timeouts:
  thorough: 180000  # 3 minutes
  standard: 120000  # 2 minutes
  light: 60000      # 1 minute

# Prompt depth per intensity (how detailed the instructions)
intensity_prompt_depth:
  thorough: detailed  # Full context, comprehensive analysis
  standard: standard  # Balanced approach
  light: brief        # Quick scan, obvious issues only

# Consensus thresholds per intensity (percentage of providers that must agree)
# Higher = more strict, requires more agreement
intensity_consensus_thresholds:
  thorough: 80  # 80% agreement for thorough review
  standard: 60  # 60% agreement for standard review
  light: 40     # 40% agreement for light review

# Severity filters per intensity (minimum severity to show inline)
# Valid values: critical, major, minor
intensity_severity_filters:
  thorough: minor    # Show all issues including minor
  standard: minor    # Show minor and above
  light: major       # Only show major and critical
```

Create the examples/config directory if it doesn't exist.
  </action>
  <verify>File exists at examples/config/intensity-patterns.yml with valid YAML syntax. Run `npx js-yaml examples/config/intensity-patterns.yml` to verify parsing.</verify>
  <done>Example config file demonstrates all intensity configuration options with comments</done>
</task>

<task type="auto">
  <name>Task 3: Document Path Pattern Precedence</name>
  <files>docs/configuration.md</files>
  <action>
Create or update docs/configuration.md to document path pattern precedence (CONFIG-03).

If file exists, add a new section. If not, create with this content:

```markdown
# Configuration Reference

## Path-Based Intensity

Path-based intensity allows different review thoroughness for different parts of your codebase.

### Enabling Path-Based Intensity

```yaml
path_based_intensity: true
path_default_intensity: standard
```

### Pattern Precedence

When multiple patterns match a file, the **highest intensity wins**.

**Intensity order (highest to lowest):**
1. `thorough` - Full analysis, most providers, longest timeout
2. `standard` - Balanced approach (default)
3. `light` - Quick scan, fewer providers, shorter timeout

**Example:**
```yaml
path_intensity_patterns: |
  [
    {"pattern": "src/core/**", "intensity": "thorough"},
    {"pattern": "src/**", "intensity": "standard"}
  ]
```

For file `src/core/auth.ts`:
- Matches `src/core/**` (thorough)
- Matches `src/**` (standard)
- **Result: thorough** (highest intensity wins)

### Intensity Behavior Mappings

Each intensity level controls multiple behaviors:

| Behavior | Thorough | Standard | Light |
|----------|----------|----------|-------|
| Providers | 8 | 5 | 3 |
| Timeout | 3 min | 2 min | 1 min |
| Prompt | detailed | standard | brief |
| Consensus | 80% | 60% | 40% |
| Min Severity | minor | minor | major |

### Configuration Options

#### `intensity_consensus_thresholds`

Percentage of providers that must agree for a finding to be reported.

```yaml
intensity_consensus_thresholds:
  thorough: 80  # 80% agreement required
  standard: 60  # 60% agreement required
  light: 40     # 40% agreement required
```

**Validation:** Values outside 0-100 are clamped with a warning.

#### `intensity_severity_filters`

Minimum severity level for inline comments.

```yaml
intensity_severity_filters:
  thorough: minor    # Show all (minor, major, critical)
  standard: minor    # Show minor and above
  light: major       # Only major and critical
```

**Validation:** Invalid values fail with typo suggestions (e.g., "majr" -> "Did you mean 'major'?").

### Common Patterns

#### Critical paths get thorough review
```yaml
path_intensity_patterns: |
  [
    {"pattern": "src/auth/**", "intensity": "thorough"},
    {"pattern": "src/payments/**", "intensity": "thorough"},
    {"pattern": "src/api/**", "intensity": "thorough"}
  ]
```

#### Documentation gets light review
```yaml
path_intensity_patterns: |
  [
    {"pattern": "docs/**", "intensity": "light"},
    {"pattern": "*.md", "intensity": "light"},
    {"pattern": "examples/**", "intensity": "light"}
  ]
```

#### Test files get standard review
```yaml
path_intensity_patterns: |
  [
    {"pattern": "tests/**", "intensity": "standard"},
    {"pattern": "**/*.test.ts", "intensity": "standard"},
    {"pattern": "**/*.spec.ts", "intensity": "standard"}
  ]
```

See [examples/config/intensity-patterns.yml](../examples/config/intensity-patterns.yml) for a complete example.
```

Create the docs directory if it doesn't exist.
  </action>
  <verify>File exists at docs/configuration.md. Content includes precedence documentation and behavior tables.</verify>
  <done>Documentation explains path pattern precedence and provides common patterns</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run build` succeeds
2. `npm test` passes
3. ConfigLoader.load() validates intensity fields
4. Example config parses without error
5. Documentation covers precedence rules
</verification>

<success_criteria>
- [ ] ConfigLoader imports and uses validators from Plan 02
- [ ] normalizeKeys handles new snake_case to camelCase conversion
- [ ] validateIntensityBehaviors called during load()
- [ ] Example config at examples/config/intensity-patterns.yml
- [ ] Documentation at docs/configuration.md with precedence rules
- [ ] Build passes, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-configuration-a-validation/06-03-SUMMARY.md`
</output>
