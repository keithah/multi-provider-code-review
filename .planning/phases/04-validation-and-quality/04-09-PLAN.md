---
phase: 04-validation-and-quality
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/setup.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "SuppressionTracker is instantiated and passed to CommentPoster"
    - "ProviderWeightTracker is instantiated and passed to CommentPoster"
    - "PromptEnricher is instantiated and passed to PromptBuilder"
    - "codeGraph passed as undefined to PromptBuilder (graph requires files, unavailable at setup)"
    - "Build succeeds with no TypeScript errors"
  artifacts:
    - path: "src/setup.ts"
      provides: "Wired learning/validation components into runtime"
      contains: "new SuppressionTracker"
  key_links:
    - from: "src/setup.ts"
      to: "CommentPoster"
      via: "constructor params"
      pattern: "new CommentPoster.*suppressionTracker"
    - from: "src/setup.ts"
      to: "PromptBuilder"
      via: "constructor params"
      pattern: "new PromptBuilder.*promptEnricher"
---

<objective>
Wire dormant Phase 4 validation and learning features into the runtime execution path.

Purpose: Phase 4 implemented full validation/learning infrastructure, but setup.ts instantiates components without the optional parameters. This gap closure activates the validation pipeline (SuppressionTracker, ProviderWeightTracker) and context-aware prompts (PromptEnricher).

Output: Updated src/setup.ts with full wiring of Phase 4 features.

**Architectural Note:** CodeGraph CANNOT be passed at setup time because it requires FileChange[] to build, which only becomes available after PR loading. PromptBuilder receives `undefined` for codeGraph at setup; the orchestrator can build and inject the graph later during review execution if needed.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation-and-quality/04-VERIFICATION.md

@src/setup.ts
@src/github/comment-poster.ts
@src/analysis/llm/prompt-builder.ts
@src/learning/suppression-tracker.ts
@src/learning/provider-weights.ts
@src/learning/prompt-enrichment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire validation trackers into CommentPoster</name>
  <files>src/setup.ts</files>
  <action>
  In both `createComponentsForCLI` and `createComponents` functions:

  1. Add imports at top of file (if not already present):
     ```typescript
     import { SuppressionTracker } from './learning/suppression-tracker';
     import { ProviderWeightTracker } from './learning/provider-weights';
     ```

  2. In `createComponentsForCLI` function (starts around line 71):
     - After `const cacheStorage = new CacheStorage();` (line 112), add:
       ```typescript
       const suppressionTracker = new SuppressionTracker(cacheStorage, 'cli-mode');
       const providerWeightTracker = new ProviderWeightTracker(cacheStorage);
       ```
     - Update CommentPoster instantiation to pass these (currently at line 144):
       ```typescript
       const commentPoster = new CommentPoster(
         mockGitHubClient,
         true,
         config,
         suppressionTracker,
         providerWeightTracker
       );
       ```

  3. In `createComponents` function (starts around line 187):
     - Create GitHubClient FIRST (move `const githubClient = new GitHubClient(githubToken);` earlier if needed)
     - After `const cacheStorage = new CacheStorage();` (line 233), add:
       ```typescript
       const repoKey = `${githubClient.owner}/${githubClient.repo}`;
       const suppressionTracker = new SuppressionTracker(cacheStorage, repoKey);
       const providerWeightTracker = new ProviderWeightTracker(cacheStorage);
       ```
       Note: Use `${githubClient.owner}/${githubClient.repo}` for proper repo-scoped suppression patterns. GitHubClient extracts this from GITHUB_REPOSITORY env var.
     - Update CommentPoster instantiation to pass these (currently at line 224):
       ```typescript
       const commentPoster = new CommentPoster(
         githubClient,
         config.dryRun,
         config,
         suppressionTracker,
         providerWeightTracker
       );
       ```

  Important:
  - The cacheStorage variable already exists in both functions, so reuse it
  - In createComponents, githubClient already exists at line 222, ensure suppressionTracker is created AFTER it
  </action>
  <verify>
  ```bash
  npm run build 2>&1 | head -20
  grep -n "new SuppressionTracker" src/setup.ts
  grep -n "new CommentPoster" src/setup.ts
  ```
  Build succeeds, grep shows SuppressionTracker instantiation and CommentPoster constructor with tracker params.
  </verify>
  <done>
  - CommentPoster in createComponents receives suppressionTracker and providerWeightTracker
  - CommentPoster in createComponentsForCLI receives suppressionTracker and providerWeightTracker
  - Production mode uses actual repo key from githubClient (owner/repo)
  - CLI mode uses 'cli-mode' key
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PromptEnricher into PromptBuilder (without CodeGraph)</name>
  <files>src/setup.ts</files>
  <action>
  In both `createComponentsForCLI` and `createComponents` functions:

  1. Add import at top of file (if not already present):
     ```typescript
     import { PromptEnricher } from './learning/prompt-enrichment';
     ```

  2. In `createComponentsForCLI` function:
     - Create PromptEnricher AFTER suppressionTracker and feedbackTracker are created, BEFORE promptBuilder:
       ```typescript
       const promptEnricher = new PromptEnricher(suppressionTracker, feedbackTracker);
       ```
     - Update PromptBuilder instantiation (currently `new PromptBuilder(config)` at line 86):
       ```typescript
       const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, undefined);
       ```
       Note: Pass `undefined` for codeGraph because CodeGraph requires FileChange[] to build (via `graphBuilder.buildGraph(files)`), which is only available during PR review execution, NOT at setup time. The orchestrator can build the graph later and inject it if needed.

  3. In `createComponents` function:
     - Same pattern: Create PromptEnricher after suppressionTracker, before promptBuilder:
       ```typescript
       const promptEnricher = new PromptEnricher(suppressionTracker, feedbackTracker);
       ```
     - Update PromptBuilder instantiation (currently `new PromptBuilder(config)` at line 202):
       ```typescript
       const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, undefined);
       ```

  **ARCHITECTURAL LIMITATION (documented):**
  The graphBuilder exists (`config.graphEnabled ? new CodeGraphBuilder(...) : undefined`) but it only has `buildGraph(files: FileChange[]): Promise<CodeGraph>` - an async method requiring files. There is NO `getGraph()` method to retrieve a pre-built graph. The graph must be built DURING review execution when files are available, not at setup time. Pass `undefined` for now; future work could inject the graph during orchestration.
  </action>
  <verify>
  ```bash
  npm run build 2>&1 | head -20
  grep -n "new PromptBuilder" src/setup.ts
  grep -n "PromptEnricher" src/setup.ts
  ```
  Build succeeds, grep shows PromptEnricher instantiation and PromptBuilder receiving enricher + undefined for graph.
  </verify>
  <done>
  - PromptBuilder in createComponents receives promptEnricher and undefined for codeGraph
  - PromptBuilder in createComponentsForCLI receives promptEnricher and undefined for codeGraph
  - Architectural limitation documented: CodeGraph requires files unavailable at setup time
  - Build passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify build and tests pass</name>
  <files>None (verification only)</files>
  <action>
  Run TypeScript build and relevant tests to ensure the wiring changes compile correctly.

  ```bash
  npm run build
  npm test -- --testPathPattern="setup|comment-poster|prompt-builder" --passWithNoTests
  ```

  Expected outcome:
  - setup.ts compiles successfully
  - No TypeScript errors from the wiring changes
  - Related tests pass (if any exist)

  If setup.ts-specific errors occur:
  - Check import paths are correct
  - Verify constructor signatures match (CommentPoster, PromptBuilder, PromptEnricher)
  - Ensure suppressionTracker/feedbackTracker are created before PromptEnricher
  </action>
  <verify>
  ```bash
  npm run build 2>&1 | grep -E "error|Error" || echo "Build succeeded"
  ```
  Output should show "Build succeeded" with no TypeScript errors.
  </verify>
  <done>
  - setup.ts compiles without TypeScript errors
  - All wiring changes are type-correct
  - Build passes
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification:
   ```bash
   npm run build
   ```
   Should complete successfully with no errors.

2. Grep verification (key wiring patterns):
   ```bash
   grep -n "new SuppressionTracker" src/setup.ts
   grep -n "new ProviderWeightTracker" src/setup.ts
   grep -n "new PromptEnricher" src/setup.ts
   grep -n "new CommentPoster" src/setup.ts
   grep -n "new PromptBuilder" src/setup.ts
   ```
   Each grep should show the component instantiated with the new dependencies.

3. Integration check:
   ```bash
   # Verify imports exist
   grep "import.*SuppressionTracker" src/setup.ts
   grep "import.*ProviderWeightTracker" src/setup.ts
   grep "import.*PromptEnricher" src/setup.ts
   ```
</verification>

<success_criteria>
1. SuppressionTracker instantiated in createComponentsForCLI with 'cli-mode' key
2. SuppressionTracker instantiated in createComponents with actual repo key (owner/repo)
3. ProviderWeightTracker instantiated in both functions
4. PromptEnricher instantiated in both functions
5. CommentPoster receives suppressionTracker and providerWeightTracker params
6. PromptBuilder receives promptEnricher and undefined for codeGraph params
7. Build succeeds with no TypeScript errors
8. Architectural limitation documented (CodeGraph unavailable at setup time)
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-quality/04-09-SUMMARY.md`
</output>
