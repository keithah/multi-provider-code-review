---
phase: 04-validation-and-quality
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - src/setup.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "SuppressionTracker is instantiated and passed to CommentPoster"
    - "ProviderWeightTracker is instantiated and passed to CommentPoster"
    - "PromptEnricher is instantiated and passed to PromptBuilder"
    - "CodeGraph from graphBuilder is passed to PromptBuilder"
    - "All 222 existing tests continue to pass"
  artifacts:
    - path: "src/setup.ts"
      provides: "Wired learning/validation components into runtime"
      contains: "new SuppressionTracker"
  key_links:
    - from: "src/setup.ts"
      to: "CommentPoster"
      via: "constructor params"
      pattern: "new CommentPoster.*suppressionTracker"
    - from: "src/setup.ts"
      to: "PromptBuilder"
      via: "constructor params"
      pattern: "new PromptBuilder.*promptEnricher"
---

<objective>
Wire dormant Phase 4 validation and learning features into the runtime execution path.

Purpose: Phase 4 implemented full validation/learning infrastructure (222 tests pass), but setup.ts instantiates components without the optional parameters. This gap closure activates the validation pipeline (SuppressionTracker, ProviderWeightTracker) and context-aware prompts (PromptEnricher, CodeGraph).

Output: Updated src/setup.ts with full wiring of Phase 4 features.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-validation-and-quality/04-VERIFICATION.md

@src/setup.ts
@src/github/comment-poster.ts
@src/analysis/llm/prompt-builder.ts
@src/learning/suppression-tracker.ts
@src/learning/provider-weights.ts
@src/learning/prompt-enrichment.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire validation trackers into CommentPoster</name>
  <files>src/setup.ts</files>
  <action>
  In both `createComponentsForCLI` and `createComponents` functions:

  1. Add imports at top of file (if not already present):
     ```typescript
     import { SuppressionTracker } from './learning/suppression-tracker';
     import { ProviderWeightTracker } from './learning/provider-weights';
     ```

  2. In `createComponentsForCLI` (around line 112-128):
     - Create SuppressionTracker instance BEFORE CommentPoster:
       ```typescript
       const suppressionTracker = new SuppressionTracker(cacheStorage, 'cli-mode');
       const providerWeightTracker = new ProviderWeightTracker(cacheStorage);
       ```
     - Update CommentPoster instantiation (line 144) to pass these:
       ```typescript
       const commentPoster = new CommentPoster(
         mockGitHubClient,
         true,
         config,
         suppressionTracker,
         providerWeightTracker
       );
       ```

  3. In `createComponents` (around line 232-260):
     - After `const cacheStorage = new CacheStorage();` (line 233), add:
       ```typescript
       const suppressionTracker = new SuppressionTracker(cacheStorage, `${owner}/${repo}`);
       const providerWeightTracker = new ProviderWeightTracker(cacheStorage);
       ```
     - Note: owner/repo come from the githubClient. Since GitHubClient stores these, we need to access them.
     - Check how GitHubClient exposes owner/repo. If not accessible, use config or derive from context.
     - Actually, looking at setup.ts, owner/repo are not available at component creation time (they come from PR context later).
     - Use a placeholder repoKey for now: `'repo-placeholder'` - the SuppressionTracker will work per-repo once prNumber is known.

     - Update CommentPoster instantiation (line 224) to pass these:
       ```typescript
       const commentPoster = new CommentPoster(
         githubClient,
         config.dryRun,
         config,
         suppressionTracker,
         providerWeightTracker
       );
       ```

  Important: The cacheStorage variable already exists (line 233 in createComponents, line 112 in createComponentsForCLI), so reuse it rather than creating a new one.
  </action>
  <verify>
  ```bash
  npm run build
  grep -n "new CommentPoster" src/setup.ts
  grep -n "SuppressionTracker" src/setup.ts
  ```
  Build succeeds, grep shows SuppressionTracker instantiation and CommentPoster constructor with tracker params.
  </verify>
  <done>
  - CommentPoster in createComponents receives suppressionTracker and providerWeightTracker
  - CommentPoster in createComponentsForCLI receives suppressionTracker and providerWeightTracker
  - Build passes with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire context-aware prompts into PromptBuilder</name>
  <files>src/setup.ts</files>
  <action>
  In both `createComponentsForCLI` and `createComponents` functions:

  1. Add import at top of file (if not already present):
     ```typescript
     import { PromptEnricher } from './learning/prompt-enrichment';
     ```
     Note: CodeGraph is already imported via CodeGraphBuilder.

  2. In `createComponentsForCLI` (around line 86):
     - Create PromptEnricher AFTER feedbackTracker (around line 113) and BEFORE promptBuilder:
       ```typescript
       const promptEnricher = new PromptEnricher(suppressionTracker, feedbackTracker);
       ```
     - Get codeGraph from graphBuilder if it exists:
       ```typescript
       const codeGraph = graphBuilder?.getGraph?.() ?? undefined;
       ```
       Note: Check CodeGraphBuilder to see if it exposes getGraph(). If not, pass undefined for codeGraph since it requires file parsing.

     - Update PromptBuilder instantiation (line 86):
       ```typescript
       const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, codeGraph);
       ```

  3. In `createComponents` (around line 202):
     - Same pattern: Create PromptEnricher after suppressionTracker, before promptBuilder
       ```typescript
       const promptEnricher = new PromptEnricher(suppressionTracker, feedbackTracker);
       ```
     - Get codeGraph from graphBuilder if available:
       ```typescript
       const codeGraph = graphBuilder?.getGraph?.() ?? undefined;
       ```

     - Update PromptBuilder instantiation:
       ```typescript
       const promptBuilder = new PromptBuilder(config, 'standard', promptEnricher, codeGraph);
       ```

  Note: The order of PromptBuilder constructor params is (config, intensity, promptEnricher, codeGraph) per prompt-builder.ts line 12-17. Use 'standard' as default intensity.

  Important: The graphBuilder is conditionally created (lines 124-126 for CLI, 245-247 for GitHub), so use optional chaining when accessing the graph.
  </action>
  <verify>
  ```bash
  npm run build
  grep -n "new PromptBuilder" src/setup.ts
  grep -n "PromptEnricher" src/setup.ts
  ```
  Build succeeds, grep shows PromptEnricher instantiation and PromptBuilder receiving enricher + graph params.
  </verify>
  <done>
  - PromptBuilder in createComponents receives promptEnricher and codeGraph
  - PromptBuilder in createComponentsForCLI receives promptEnricher and codeGraph
  - Build passes with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify all tests still pass</name>
  <files>None (verification only)</files>
  <action>
  Run the full test suite to ensure the wiring changes don't break existing functionality.

  The Phase 4 verification showed 222 tests passing - this must remain true after wiring.

  ```bash
  npm test
  ```

  If any tests fail:
  - Check if failures are due to mock expectations changing (tests might not expect the new constructor params)
  - Update test mocks if needed to provide the new optional params
  - Do NOT remove functionality to make tests pass
  </action>
  <verify>
  ```bash
  npm test 2>&1 | tail -20
  ```
  Output shows "222 passing" or similar all-green result.
  </verify>
  <done>
  - All 222+ tests pass
  - No regressions introduced by wiring changes
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification:
   ```bash
   npm run build && echo "Build OK"
   ```

2. Grep verification (key wiring patterns):
   ```bash
   grep -n "new SuppressionTracker" src/setup.ts
   grep -n "new ProviderWeightTracker" src/setup.ts
   grep -n "new PromptEnricher" src/setup.ts
   grep -n "new CommentPoster" src/setup.ts
   grep -n "new PromptBuilder" src/setup.ts
   ```
   Each grep should show the component instantiated with the new dependencies.

3. Test verification:
   ```bash
   npm test
   ```
   All tests pass.
</verification>

<success_criteria>
1. SuppressionTracker instantiated in both createComponentsForCLI and createComponents
2. ProviderWeightTracker instantiated in both functions
3. PromptEnricher instantiated in both functions
4. CommentPoster receives suppressionTracker and providerWeightTracker params
5. PromptBuilder receives promptEnricher and codeGraph params
6. Build succeeds with no TypeScript errors
7. All existing tests pass (222+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-quality/04-09-SUMMARY.md`
</output>
