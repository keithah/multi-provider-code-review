---
phase: 04-validation-and-quality
plan: 08
type: tdd
wave: 3
depends_on: ["04-04"]
files_modified:
  - src/learning/acceptance-detector.ts
  - src/github/feedback.ts
  - __tests__/learning/acceptance-detector.test.ts
autonomous: true

must_haves:
  truths:
    - "Suggestion acceptances are detected from PR commit history"
    - "Accepted suggestions trigger positive feedback to ProviderWeightTracker"
    - "Detection uses GitHub's 'Commit suggestion' commit message pattern"
    - "Both thumbs-up reactions AND committed suggestions count as accepts"
  artifacts:
    - path: "src/learning/acceptance-detector.ts"
      provides: "AcceptanceDetector class"
      exports: ["AcceptanceDetector", "SuggestionAcceptance"]
    - path: "__tests__/learning/acceptance-detector.test.ts"
      provides: "Acceptance detector tests"
      contains: "describe.*AcceptanceDetector"
  key_links:
    - from: "src/learning/acceptance-detector.ts"
      to: "src/learning/provider-weights.ts"
      via: "ProviderWeightTracker"
      pattern: "ProviderWeightTracker|recordFeedback"
    - from: "src/github/feedback.ts"
      to: "src/learning/acceptance-detector.ts"
      via: "AcceptanceDetector"
      pattern: "AcceptanceDetector|detectAcceptances"
---

<objective>
TDD implementation of suggestion acceptance tracking to complement dismissal tracking (Plan 04).

Purpose: Per CONTEXT.md decision: "Track both accepts (committed) and dismissals." Plan 04 implements dismissal tracking via thumbs-down reactions. This plan implements acceptance tracking via:
1. GitHub's "Commit suggestion" feature (detected via commit message pattern)
2. Thumbs-up reactions on suggestion comments

When users accept suggestions, providers should receive positive feedback to improve their weight in confidence calculations.

Output: Working `AcceptanceDetector` class that detects accepted suggestions and reports positive feedback.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-validation-and-quality/04-CONTEXT.md
@src/learning/provider-weights.ts
@src/github/feedback.ts
@.planning/phases/04-validation-and-quality/04-04-SUMMARY.md
</context>

<feature>
  <name>Acceptance Detector</name>
  <files>src/learning/acceptance-detector.ts, __tests__/learning/acceptance-detector.test.ts</files>
  <behavior>
    class AcceptanceDetector {
      detectFromCommits(commits) -> SuggestionAcceptance[]
      detectFromReactions(comments, reactions) -> SuggestionAcceptance[]
      recordAcceptances(acceptances, weightTracker) -> Promise<void>
    }

    Cases for detectFromCommits:
    - "Apply suggestions from code review" commit -> acceptance detected
    - "Co-authored-by: @user" with suggestion pattern -> acceptance detected
    - Regular commit without suggestion pattern -> not detected
    - Batch commit "Apply 3 suggestions" -> multiple acceptances

    Detection patterns (GitHub's "Commit suggestion" formats):
    - "Apply suggestions from code review"
    - "Apply suggestion from code review"
    - "Apply suggestions from @username"
    - Contains "Co-authored-by:" and touches files with our comments

    Cases for detectFromReactions:
    - Comment with thumbs-up reaction -> acceptance detected
    - Comment with no positive reaction -> not detected
    - Comment with thumbs-down reaction -> dismissal (handled by Plan 04)

    Recording:
    - For each acceptance, call weightTracker.recordFeedback(provider, 'üëç')
    - Provider determined from comment metadata (stored provider attribution)
  </behavior>
  <implementation>
    Interface:
    ```typescript
    export interface SuggestionAcceptance {
      file: string;
      line: number;
      provider: string;
      commitSha?: string;       // If detected from commit
      commentId?: number;       // If detected from reaction
      timestamp: number;
    }

    export interface CommitInfo {
      sha: string;
      message: string;
      files: string[];          // Files changed in commit
      timestamp: number;
    }

    export interface CommentReaction {
      commentId: number;
      file: string;
      line: number;
      provider?: string;        // Provider attribution if available
      reactions: Array<{ user: string; content: string }>;
    }

    export class AcceptanceDetector {
      private readonly SUGGESTION_COMMIT_PATTERNS = [
        /Apply suggestions? from code review/i,
        /Apply suggestions? from @[\w-]+/i,
        /Apply \d+ suggestions?/i,
      ];

      /**
       * Detect acceptances from PR commits.
       * GitHub's "Commit suggestion" creates commits with specific patterns.
       */
      detectFromCommits(
        commits: CommitInfo[],
        commentedFiles: Map<string, { line: number; provider?: string }[]>
      ): SuggestionAcceptance[] {
        const acceptances: SuggestionAcceptance[] = [];

        for (const commit of commits) {
          const isSuggestionCommit = this.SUGGESTION_COMMIT_PATTERNS.some(p => p.test(commit.message));
          if (!isSuggestionCommit) continue;

          // Match commit files against commented files
          for (const file of commit.files) {
            const comments = commentedFiles.get(file);
            if (!comments) continue;

            for (const comment of comments) {
              acceptances.push({
                file,
                line: comment.line,
                provider: comment.provider || 'unknown',
                commitSha: commit.sha,
                timestamp: commit.timestamp,
              });
            }
          }
        }

        return acceptances;
      }

      /**
       * Detect acceptances from thumbs-up reactions on suggestion comments.
       */
      detectFromReactions(commentReactions: CommentReaction[]): SuggestionAcceptance[] {
        const acceptances: SuggestionAcceptance[] = [];

        for (const comment of commentReactions) {
          const hasThumbsUp = comment.reactions.some(r => r.content === '+1');
          if (!hasThumbsUp) continue;

          acceptances.push({
            file: comment.file,
            line: comment.line,
            provider: comment.provider || 'unknown',
            commentId: comment.commentId,
            timestamp: Date.now(),
          });
        }

        return acceptances;
      }

      /**
       * Record acceptances as positive feedback to weight tracker.
       */
      async recordAcceptances(
        acceptances: SuggestionAcceptance[],
        weightTracker: ProviderWeightTracker
      ): Promise<void> {
        for (const acceptance of acceptances) {
          if (acceptance.provider && acceptance.provider !== 'unknown') {
            await weightTracker.recordFeedback(acceptance.provider, 'üëç');
          }
        }
      }
    }
    ```

    Create test file with cases:
    - Commit with "Apply suggestions from code review" detected
    - Commit with "Apply 3 suggestions" detected
    - Regular commit not detected
    - Thumbs-up reaction detected as acceptance
    - No thumbs-up reaction not detected
    - Recording calls weightTracker correctly
  </implementation>
</feature>

<verification>
```bash
npm test -- --testPathPattern="acceptance-detector" --verbose
```
All tests pass. Coverage includes:
- Commit pattern detection
- Reaction detection
- Recording to weight tracker
</verification>

<success_criteria>
- RED: Tests fail because class doesn't exist
- GREEN: Tests pass with implementation
- REFACTOR: Extract patterns, add JSDoc
- "Apply suggestions from code review" commits are detected
- Thumbs-up reactions are detected as acceptances
- Provider weights receive positive feedback for acceptances
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-quality/04-08-SUMMARY.md`
</output>
