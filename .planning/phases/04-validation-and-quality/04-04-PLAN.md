---
phase: 04-validation-and-quality
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/learning/suppression-tracker.ts
  - __tests__/learning/suppression-tracker.test.ts
autonomous: true

must_haves:
  truths:
    - "Dismissed suggestions are recorded as suppression patterns"
    - "Similar suggestions in same PR are suppressed after dismissal"
    - "Similar suggestions in same repo are suppressed (configurable scope)"
    - "Similarity detection uses file + category + line proximity"
  artifacts:
    - path: "src/learning/suppression-tracker.ts"
      provides: "SuppressionTracker class"
      exports: ["SuppressionTracker", "SuppressionPattern"]
    - path: "__tests__/learning/suppression-tracker.test.ts"
      provides: "Suppression tracker tests"
      contains: "describe.*Suppression"
  key_links:
    - from: "src/learning/suppression-tracker.ts"
      to: "src/cache/storage.ts"
      via: "CacheStorage"
      pattern: "CacheStorage"
---

<objective>
TDD implementation of suppression tracking for dismissed suggestions.

Purpose: When users give thumbs-down reactions to suggestions, suppress similar suggestions in the same PR or repo to avoid showing unwanted patterns repeatedly. Per CONTEXT.md, similarity uses file + category + line proximity.

Output: Working `SuppressionTracker` class with methods to record dismissals and check for suppression.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-validation-and-quality/04-CONTEXT.md
@.planning/phases/04-validation-and-quality/04-RESEARCH.md
@src/learning/feedback-tracker.ts
@src/cache/storage.ts
</context>

<feature>
  <name>Suppression Tracker</name>
  <files>src/learning/suppression-tracker.ts, __tests__/learning/suppression-tracker.test.ts</files>
  <behavior>
    class SuppressionTracker {
      recordDismissal(finding, scope) -> Promise<void>
      shouldSuppress(finding) -> Promise<boolean>
      clearExpired() -> Promise<number>
    }

    Cases for recordDismissal:
    - PR scope: Records pattern scoped to current PR only
    - Repo scope: Records pattern scoped to entire repository

    Cases for shouldSuppress:
    - Exact match: Same file + category + line -> true
    - Near match: Same file + category + line within 5 lines -> true
    - Different file: Same category but different file -> false
    - Different category: Same file but different category -> false
    - Expired pattern: Pattern older than TTL -> false (cleaned up)

    Similarity detection (simple heuristics per CONTEXT.md discretion):
    1. Same category (e.g., 'null-check', 'type-safety')
    2. Same file
    3. Line within 5 lines of dismissed finding
    4. Scope matches (PR or repo)
  </behavior>
  <implementation>
    Interface:
    ```typescript
    interface SuppressionPattern {
      id: string;                   // UUID
      category: string;
      file: string;
      line: number;
      scope: 'pr' | 'repo';
      prNumber?: number;            // Required if scope='pr'
      timestamp: number;
      expiresAt: number;            // TTL: 7 days for PR, 30 days for repo
    }

    interface SuppressionData {
      patterns: SuppressionPattern[];
      lastCleanup: number;
    }

    class SuppressionTracker {
      constructor(storage: CacheStorage, repoKey: string)

      async recordDismissal(
        finding: { category: string; file: string; line: number },
        scope: 'pr' | 'repo',
        prNumber?: number
      ): Promise<void>

      async shouldSuppress(
        finding: { category: string; file: string; line: number },
        prNumber: number
      ): Promise<boolean>

      async clearExpired(): Promise<number>  // Returns count cleared
    }
    ```

    Similarity matching:
    - Exact: file === pattern.file && category === pattern.category && line === pattern.line
    - Near: file === pattern.file && category === pattern.category && Math.abs(line - pattern.line) <= 5

    Scope matching:
    - PR scope: Only match if prNumber matches pattern.prNumber
    - Repo scope: Match any PR in same repo

    TTL:
    - PR scope: 7 days (short-lived, just for this PR)
    - Repo scope: 30 days (longer learning period)
  </implementation>
</feature>

<verification>
```bash
npm test -- --testPathPattern="suppression-tracker" --verbose
```
All tests pass. Coverage includes:
- Recording dismissals with PR scope
- Recording dismissals with repo scope
- Exact match suppression
- Near match suppression (within 5 lines)
- No suppression for different files
- No suppression for different categories
- Expired pattern cleanup
</verification>

<success_criteria>
- RED: Tests fail because SuppressionTracker doesn't exist
- GREEN: Tests pass with pattern matching logic
- REFACTOR: Extract constants, add index for faster lookup
- PR-scoped patterns only affect that PR
- Repo-scoped patterns affect all PRs
- Expired patterns are cleaned up
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-quality/04-04-SUMMARY.md`
</output>
