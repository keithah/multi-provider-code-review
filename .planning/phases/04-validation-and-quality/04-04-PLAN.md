---
phase: 04-validation-and-quality
plan: 04
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/learning/suppression-tracker.ts
  - src/learning/provider-weights.ts
  - __tests__/learning/suppression-tracker.test.ts
  - __tests__/learning/provider-weights.test.ts
autonomous: true

must_haves:
  truths:
    - "Dismissed suggestions are recorded as suppression patterns"
    - "Similar suggestions in same PR are suppressed after dismissal"
    - "Similar suggestions in same repo are suppressed (configurable scope)"
    - "Similarity detection uses file + category + line proximity"
    - "Provider weights are adjusted based on feedback (thumbs up/down)"
    - "Low-performing providers get lower weights in confidence calculation"
  artifacts:
    - path: "src/learning/suppression-tracker.ts"
      provides: "SuppressionTracker class"
      exports: ["SuppressionTracker", "SuppressionPattern"]
    - path: "src/learning/provider-weights.ts"
      provides: "ProviderWeightTracker class"
      exports: ["ProviderWeightTracker", "ProviderWeight"]
    - path: "__tests__/learning/suppression-tracker.test.ts"
      provides: "Suppression tracker tests"
      contains: "describe.*Suppression"
    - path: "__tests__/learning/provider-weights.test.ts"
      provides: "Provider weights tests"
      contains: "describe.*ProviderWeight"
  key_links:
    - from: "src/learning/suppression-tracker.ts"
      to: "src/cache/storage.ts"
      via: "CacheStorage"
      pattern: "CacheStorage"
    - from: "src/learning/provider-weights.ts"
      to: "src/cache/storage.ts"
      via: "CacheStorage"
      pattern: "CacheStorage"
---

<objective>
TDD implementation of suppression tracking AND provider weight adjustment for learning from feedback.

Purpose: When users give thumbs-down reactions to suggestions:
1. Suppress similar suggestions in the same PR or repo (per CONTEXT.md)
2. Adjust provider weights so low-performing providers contribute less to confidence scores

Per CONTEXT.md decision: "Learning mechanisms: Both provider weight adjustment AND prompt context enrichment"

Output: Working `SuppressionTracker` and `ProviderWeightTracker` classes.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-validation-and-quality/04-CONTEXT.md
@.planning/phases/04-validation-and-quality/04-RESEARCH.md
@src/learning/feedback-tracker.ts
@src/cache/storage.ts
</context>

<feature>
  <name>Suppression Tracker</name>
  <files>src/learning/suppression-tracker.ts, __tests__/learning/suppression-tracker.test.ts</files>
  <behavior>
    class SuppressionTracker {
      recordDismissal(finding, scope) -> Promise<void>
      shouldSuppress(finding) -> Promise<boolean>
      clearExpired() -> Promise<number>
    }

    Cases for recordDismissal:
    - PR scope: Records pattern scoped to current PR only
    - Repo scope: Records pattern scoped to entire repository

    Cases for shouldSuppress:
    - Exact match: Same file + category + line -> true
    - Near match: Same file + category + line within 5 lines -> true
    - Different file: Same category but different file -> false
    - Different category: Same file but different category -> false
    - Expired pattern: Pattern older than TTL -> false (cleaned up)

    Similarity detection (simple heuristics per CONTEXT.md discretion):
    1. Same category (e.g., 'null-check', 'type-safety')
    2. Same file
    3. Line within 5 lines of dismissed finding
    4. Scope matches (PR or repo)
  </behavior>
  <implementation>
    Interface:
    ```typescript
    interface SuppressionPattern {
      id: string;                   // UUID
      category: string;
      file: string;
      line: number;
      scope: 'pr' | 'repo';
      prNumber?: number;            // Required if scope='pr'
      timestamp: number;
      expiresAt: number;            // TTL: 7 days for PR, 30 days for repo
    }

    interface SuppressionData {
      patterns: SuppressionPattern[];
      lastCleanup: number;
    }

    class SuppressionTracker {
      constructor(storage: CacheStorage, repoKey: string)

      async recordDismissal(
        finding: { category: string; file: string; line: number },
        scope: 'pr' | 'repo',
        prNumber?: number
      ): Promise<void>

      async shouldSuppress(
        finding: { category: string; file: string; line: number },
        prNumber: number
      ): Promise<boolean>

      async clearExpired(): Promise<number>  // Returns count cleared
    }
    ```

    Similarity matching:
    - Exact: file === pattern.file && category === pattern.category && line === pattern.line
    - Near: file === pattern.file && category === pattern.category && Math.abs(line - pattern.line) <= 5

    Scope matching:
    - PR scope: Only match if prNumber matches pattern.prNumber
    - Repo scope: Match any PR in same repo

    TTL:
    - PR scope: 7 days (short-lived, just for this PR)
    - Repo scope: 30 days (longer learning period)
  </implementation>
</feature>

<feature>
  <name>Provider Weight Tracker</name>
  <files>src/learning/provider-weights.ts, __tests__/learning/provider-weights.test.ts</files>
  <behavior>
    class ProviderWeightTracker {
      recordFeedback(provider, reaction) -> Promise<void>
      getWeight(provider) -> Promise<number>
      getAllWeights() -> Promise<Record<string, ProviderWeight>>
    }

    Cases for recordFeedback:
    - Thumbs up: Increases provider's positive count
    - Thumbs down: Increases provider's negative count
    - Weight recalculated after feedback

    Cases for getWeight:
    - New provider (no feedback): 1.0 (full weight)
    - High performing (>80% positive): 1.0 (maintain full weight)
    - Medium performing (50-80% positive): 0.8-1.0 (slight reduction)
    - Low performing (<50% positive): 0.5-0.8 (significant reduction)
    - Very low performing (<30% positive): 0.3-0.5 (heavy penalty)
    - Minimum weight: 0.3 (never fully exclude a provider)

    Weight formula:
    - baseWeight = 0.3
    - variableWeight = 0.7 * positiveRate
    - weight = baseWeight + variableWeight
    - Result: 0.3 (0% positive) to 1.0 (100% positive)
  </behavior>
  <implementation>
    Interface:
    ```typescript
    interface ProviderWeight {
      provider: string;
      positiveCount: number;
      negativeCount: number;
      totalCount: number;
      positiveRate: number;
      weight: number;              // 0.3-1.0
      lastUpdated: number;
    }

    interface ProviderWeightData {
      weights: Record<string, ProviderWeight>;
      lastAggregation: number;
    }

    class ProviderWeightTracker {
      constructor(storage: CacheStorage)

      async recordFeedback(
        provider: string,
        reaction: 'üëç' | 'üëé'
      ): Promise<void>

      async getWeight(provider: string): Promise<number>

      async getAllWeights(): Promise<Record<string, ProviderWeight>>

      async recalculateWeights(): Promise<void>
    }
    ```

    Weight calculation:
    - MIN_WEIGHT = 0.3 (floor - never fully exclude)
    - VARIABLE_WEIGHT = 0.7
    - weight = MIN_WEIGHT + (VARIABLE_WEIGHT * positiveRate)
    - Requires minimum 5 feedback records before adjusting from 1.0
  </implementation>
</feature>

<verification>
```bash
npm test -- --testPathPattern="suppression-tracker|provider-weights" --verbose
```
All tests pass. Coverage includes:
- Suppression: Recording, matching, expiry
- Weights: Recording feedback, weight calculation, minimum thresholds
</verification>

<success_criteria>
- RED: Tests fail because classes don't exist
- GREEN: Tests pass with implementation
- REFACTOR: Extract constants, add JSDoc
- PR-scoped patterns only affect that PR
- Repo-scoped patterns affect all PRs
- Provider weights range from 0.3 to 1.0
- Minimum feedback threshold (5) before weight adjustment
</success_criteria>

<output>
After completion, create `.planning/phases/04-validation-and-quality/04-04-SUMMARY.md`
</output>
