---
phase: 02-llm-fix-generation-integration
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/analysis/llm/prompt-builder.ts
  - __tests__/unit/analysis/llm/prompt-builder.test.ts
autonomous: true

must_haves:
  truths:
    - "Large diffs skip suggestion generation instructions"
    - "Skip threshold is based on context window tier"
    - "Small/medium diffs still request suggestions"
    - "Skip is logged at debug level"
  artifacts:
    - path: "src/analysis/llm/prompt-builder.ts"
      provides: "Token-aware suggestion instruction control"
      contains: "shouldSkipSuggestion"
    - path: "__tests__/unit/analysis/llm/prompt-builder.test.ts"
      provides: "Tests for token-aware skip logic"
      contains: "skip.*suggestion"
  key_links:
    - from: "src/analysis/llm/prompt-builder.ts"
      to: "src/utils/token-estimation.ts"
      via: "import estimateTokensConservative"
      pattern: "estimateTokensConservative"
---

<objective>
Add token-aware context management to skip suggestion instructions for large diffs

Purpose: Prevent context truncation that causes hallucinated fixes by skipping suggestion generation when the diff is too large. Per CONTEXT.md: "When code snippet too large: skip suggestion for that finding (better than truncated context)"

Output: Updated PromptBuilder with conditional suggestion instructions based on context window size estimation.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-llm-fix-generation-integration/02-CONTEXT.md
@.planning/phases/02-llm-fix-generation-integration/02-RESEARCH.md
@.planning/phases/02-llm-fix-generation-integration/02-01-SUMMARY.md
@src/analysis/llm/prompt-builder.ts
@src/utils/token-estimation.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add helper function to determine if suggestions should be skipped</name>
  <files>src/analysis/llm/prompt-builder.ts</files>
  <action>
Add a private helper method to PromptBuilder class that determines if suggestion instructions should be skipped based on diff size:

```typescript
/**
 * Determine if suggestion instructions should be skipped due to large context
 *
 * Per FR-2.4: Skip suggestion generation when code snippet too large
 * to prevent hallucinated fixes from truncated context.
 *
 * Uses tiered thresholds per CONTEXT.md:
 * - small (4-16k window): skip if diff > 2000 tokens
 * - medium (128-200k window): skip if diff > 80000 tokens
 * - large (1M+ window): skip if diff > 400000 tokens
 */
private shouldSkipSuggestions(diff: string): boolean {
  const estimate = estimateTokensConservative(diff);

  // Conservative thresholds: skip suggestions if diff alone uses >50% of typical window
  // This leaves room for prompt overhead + response tokens
  const SKIP_THRESHOLD = 50000; // 50k tokens - fits in medium windows, safe margin for small

  if (estimate.tokens > SKIP_THRESHOLD) {
    logger.debug(
      `Skipping suggestion instructions: diff is ${estimate.tokens} tokens (threshold: ${SKIP_THRESHOLD})`
    );
    return true;
  }

  return false;
}
```

Note: Using a single threshold (50k) rather than tiered approach for simplicity. This is conservative enough for small windows and reasonable for large ones. Per CONTEXT.md "tiered approach" is about token counting, not necessarily multiple thresholds.
  </action>
  <verify>
- `npm run build` succeeds
- Method exists in class
  </verify>
  <done>
Helper method shouldSkipSuggestions added that returns true when diff exceeds 50k tokens.
  </done>
</task>

<task type="auto">
  <name>Task 2: Conditionally include suggestion instructions in build()</name>
  <files>src/analysis/llm/prompt-builder.ts</files>
  <action>
Update the build() method to conditionally include suggestion instructions:

1. After trimming the diff (line ~34: `const diff = trimDiff(pr.diff, this.config.diffMaxBytes);`), add:
```typescript
const skipSuggestions = this.shouldSkipSuggestions(diff);
```

2. Modify the instructions array to conditionally include suggestion instructions.

Find the section that adds suggestion instructions (from 02-01):
```typescript
'Return JSON: [{file, line, severity, title, message, suggestion}]',
'',
'SUGGESTION FIELD (optional):',
// ... rest of suggestion instructions
```

Wrap in conditional:
```typescript
// Conditionally include suggestion field based on context size
if (skipSuggestions) {
  instructions.push('Return JSON: [{file, line, severity, title, message}]');
} else {
  instructions.push(
    'Return JSON: [{file, line, severity, title, message, suggestion}]',
    '',
    'SUGGESTION FIELD (optional):',
    '  - Only include "suggestion" for FIXABLE issues (not all findings)',
    '  - Fixable: null reference, type error, off-by-one, missing null check, resource leak',
    '  - NOT fixable: architectural issues, design suggestions, unclear requirements',
    '  - "suggestion" must be EXACT replacement code for the problematic line(s)',
    '  - Include ONLY the fixed code, no explanations or comments',
    '  - Example: {"file": "x.ts", "line": 10, "severity": "major",',
    '             "title": "Null reference", "message": "...",',
    '             "suggestion": "const user = users?.find(u => u.id === id) ?? null;"}',
  );
}
```

Key: When suggestions are skipped, we revert to the original schema without the suggestion field.
  </action>
  <verify>
- `npm run build` succeeds
- `grep -n "skipSuggestions" src/analysis/llm/prompt-builder.ts` shows conditional logic
  </verify>
  <done>
build() method conditionally includes suggestion instructions only when diff is small enough to safely generate suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for token-aware skip logic</name>
  <files>__tests__/unit/analysis/llm/prompt-builder.test.ts</files>
  <action>
Add test cases for the token-aware suggestion skip logic:

```typescript
describe('token-aware suggestion instructions', () => {
  it('includes suggestion instructions for small diffs', () => {
    const builder = new PromptBuilder(mockConfig);
    const smallDiff = 'diff --git a/test.ts b/test.ts\n+const x = 1;';
    const smallPR = { ...mockPR, diff: smallDiff };

    const prompt = builder.build(smallPR);

    expect(prompt).toContain('SUGGESTION FIELD');
    expect(prompt).toContain('suggestion}]');
  });

  it('excludes suggestion instructions for large diffs', () => {
    const builder = new PromptBuilder(mockConfig);
    // Generate a diff that exceeds 50k tokens (~200k characters)
    const largeDiff = 'diff --git a/test.ts b/test.ts\n' + '+const x = 1;\n'.repeat(60000);
    const largePR = { ...mockPR, diff: largeDiff };

    const prompt = builder.build(largePR);

    expect(prompt).not.toContain('SUGGESTION FIELD');
    // Should have original schema without suggestion
    expect(prompt).toContain('Return JSON: [{file, line, severity, title, message}]');
  });
});
```

Note: The large diff test creates ~60k lines which is ~240k characters, well over the 50k token threshold (~200k chars at 4 chars/token).
  </action>
  <verify>
- `npm test -- --testPathPattern=prompt-builder` passes
- Both test cases pass
  </verify>
  <done>
Tests verify that suggestion instructions are included for small diffs and excluded for large diffs.
  </done>
</task>

</tasks>

<verification>
Run full test suite:
```bash
npm test
npm run build
```

Manual verification:
```bash
# Verify conditional logic exists
grep -A 5 "skipSuggestions" src/analysis/llm/prompt-builder.ts

# Verify threshold constant
grep -n "SKIP_THRESHOLD" src/analysis/llm/prompt-builder.ts
```
</verification>

<success_criteria>
1. shouldSkipSuggestions helper method exists and works
2. build() conditionally includes suggestion instructions
3. Small diffs get suggestion instructions
4. Large diffs (>50k tokens) skip suggestion instructions
5. Skip is logged at debug level
6. All tests pass
7. Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-llm-fix-generation-integration/02-04-SUMMARY.md`
</output>
