---
phase: 02-llm-fix-generation-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/analysis/llm/prompt-builder.ts
  - __tests__/unit/analysis/llm/prompt-builder.test.ts
autonomous: true

must_haves:
  truths:
    - "LLM prompts include fix generation instructions in system message"
    - "Prompts specify JSON schema with optional suggestion field"
    - "Instructions distinguish fixable vs non-fixable issue types"
    - "Example JSON shows suggestion field with actual code"
  artifacts:
    - path: "src/analysis/llm/prompt-builder.ts"
      provides: "Fix generation instructions in prompt"
      contains: "suggestion"
    - path: "__tests__/unit/analysis/llm/prompt-builder.test.ts"
      provides: "Test coverage for suggestion instructions"
      contains: "suggestion"
  key_links:
    - from: "src/analysis/llm/prompt-builder.ts"
      to: "LLM response"
      via: "JSON schema in prompt"
      pattern: "suggestion.*optional|SUGGESTION FIELD"
---

<objective>
Extend PromptBuilder to request fix suggestions from LLMs during code review

Purpose: Enable LLMs to generate one-click fix suggestions alongside their code review findings. This is the foundation that makes all downstream suggestion handling meaningful.

Output: Updated PromptBuilder.build() that includes fix generation instructions, JSON schema with suggestion field, and guidance on fixable vs non-fixable issue types.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-llm-fix-generation-integration/02-CONTEXT.md
@.planning/phases/02-llm-fix-generation-integration/02-RESEARCH.md
@src/analysis/llm/prompt-builder.ts
@src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fix generation instructions to PromptBuilder</name>
  <files>src/analysis/llm/prompt-builder.ts</files>
  <action>
Update the `instructions` array in `PromptBuilder.build()` method to include fix generation guidance:

1. Update the JSON schema line from:
   `Return JSON: [{file, line, severity, title, message}]`
   to:
   `Return JSON: [{file, line, severity, title, message, suggestion}]`

2. Add a new section after the JSON schema line with these instructions:
```
'',
'SUGGESTION FIELD (optional):',
'  - Only include "suggestion" for FIXABLE issues (not all findings)',
'  - Fixable: null reference, type error, off-by-one, missing null check, resource leak',
'  - NOT fixable: architectural issues, design suggestions, unclear requirements',
'  - "suggestion" must be EXACT replacement code for the problematic line(s)',
'  - Include ONLY the fixed code, no explanations or comments',
'  - Example: {"file": "x.ts", "line": 10, "severity": "major",',
'             "title": "Null reference", "message": "...",',
'             "suggestion": "const user = users?.find(u => u.id === id) ?? null;"}',
```

3. Place this section BEFORE the "PR #..." line and AFTER the "Return JSON" line.

4. Do NOT modify any other logic - this is purely additive to the instructions array.

Rationale per CONTEXT.md decisions:
- Add to system message (applies to all requests)
- Uniform prompts across all providers
- Allowlist approach for fixable types
- Strict validation approach (no retries)
  </action>
  <verify>
- `npm run build` succeeds
- `grep -n "suggestion" src/analysis/llm/prompt-builder.ts` shows the new instructions
  </verify>
  <done>
PromptBuilder.build() includes fix generation instructions with JSON schema showing suggestion field, fixable type guidance, and example JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add/update tests for suggestion instructions</name>
  <files>__tests__/unit/analysis/llm/prompt-builder.test.ts</files>
  <action>
Check if test file exists. If not, create it with basic structure.

Add test case(s) to verify fix generation instructions are included:

```typescript
describe('PromptBuilder', () => {
  describe('build()', () => {
    it('includes suggestion field in JSON schema', () => {
      const builder = new PromptBuilder(mockConfig);
      const prompt = builder.build(mockPR);

      expect(prompt).toContain('suggestion');
      expect(prompt).toContain('Return JSON: [{file, line, severity, title, message, suggestion}]');
    });

    it('includes fixable issue type guidance', () => {
      const builder = new PromptBuilder(mockConfig);
      const prompt = builder.build(mockPR);

      expect(prompt).toContain('SUGGESTION FIELD');
      expect(prompt).toContain('Fixable:');
      expect(prompt).toContain('NOT fixable:');
    });

    it('includes example JSON with suggestion field', () => {
      const builder = new PromptBuilder(mockConfig);
      const prompt = builder.build(mockPR);

      expect(prompt).toContain('"suggestion":');
    });
  });
});
```

Use minimal mock objects (mockConfig, mockPR) that satisfy the type requirements. Follow existing test patterns in the codebase.
  </action>
  <verify>
- `npm test -- --testPathPattern=prompt-builder` passes
- Test coverage confirms suggestion instructions are tested
  </verify>
  <done>
Tests verify that PromptBuilder includes suggestion field in JSON schema, fixable type guidance, and example JSON.
  </done>
</task>

</tasks>

<verification>
Run full test suite to ensure no regressions:
```bash
npm test
npm run build
```

Manual verification:
```bash
grep -A 20 "SUGGESTION FIELD" src/analysis/llm/prompt-builder.ts
```
</verification>

<success_criteria>
1. PromptBuilder.build() output includes "suggestion" in JSON schema
2. Prompt includes fixable vs non-fixable guidance
3. Prompt includes example JSON with suggestion field
4. All tests pass
5. No changes to other functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-llm-fix-generation-integration/02-01-SUMMARY.md`
</output>
