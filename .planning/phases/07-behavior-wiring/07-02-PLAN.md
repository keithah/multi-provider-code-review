---
phase: 07-behavior-wiring
plan: 02
type: tdd
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/core/orchestrator.ts
  - __tests__/unit/core/orchestrator.test.ts
  - __tests__/unit/core/intensity.test.ts
autonomous: true

must_haves:
  truths:
    - "Thorough intensity requires 80% provider agreement"
    - "Standard intensity requires 60% provider agreement"
    - "Light intensity requires 40% provider agreement"
    - "Thorough shows all severities (minor and above)"
    - "Standard shows minor severity and above"
    - "Light shows only major and critical"
  artifacts:
    - path: "src/core/orchestrator.ts"
      provides: "Intensity-aware consensus and severity wiring"
      contains: "intensityConsensusThresholds"
    - path: "__tests__/unit/core/orchestrator.test.ts"
      provides: "Consensus threshold tests"
      contains: "consensusThreshold"
  key_links:
    - from: "src/core/orchestrator.ts"
      to: "ConsensusEngine"
      via: "intensity-based parameters"
      pattern: "new ConsensusEngine"
---

<objective>
Wire intensity-based consensus thresholds and severity filtering into ReviewOrchestrator using TDD.

Purpose: ConsensusEngine already accepts minAgreement and minSeverity parameters. This plan wires intensity-specific values from config into those parameters so thorough reviews require higher agreement and show more findings, while light reviews require lower agreement and show only critical issues.

Output: Orchestrator passes intensity-specific consensus thresholds and severity filters to ConsensusEngine.
</objective>

<execution_context>
@/Users/keith/.claude/get-shit-done/workflows/execute-plan.md
@/Users/keith/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-behavior-wiring/07-RESEARCH.md
@.planning/phases/07-behavior-wiring/07-01-SUMMARY.md

Reference files:
@src/core/orchestrator.ts
@src/analysis/consensus.ts
@src/config/defaults.ts
@__tests__/unit/core/orchestrator.test.ts
@__tests__/unit/consensus.test.ts
</context>

<feature>
  <name>Intensity-aware consensus and severity wiring</name>
  <files>src/core/orchestrator.ts, __tests__/unit/core/orchestrator.test.ts, __tests__/unit/core/intensity.test.ts</files>
  <behavior>
    ReviewOrchestrator.executeReview() should wire intensity-specific thresholds:

    CONSENSUS THRESHOLDS (convert percentage to provider count):
    - Thorough: 80% → Math.ceil(0.80 * providerCount)
    - Standard: 60% → Math.ceil(0.60 * providerCount)
    - Light: 40% → Math.ceil(0.40 * providerCount)

    SEVERITY FILTERS (from config.intensitySeverityFilters):
    - Thorough: 'minor' (show all findings)
    - Standard: 'minor' (show minor and above)
    - Light: 'major' (show only major and critical)

    Edge cases:
    - 0 providers → minAgreement = 1 (fallback)
    - providerCount * percentage rounds UP (Math.ceil)
    - Missing config → use existing defaults

    Test cases:
    - Given 5 providers + thorough → minAgreement = 4 (80% of 5)
    - Given 5 providers + standard → minAgreement = 3 (60% of 5)
    - Given 5 providers + light → minAgreement = 2 (40% of 5)
    - Given thorough → minSeverity = 'minor'
    - Given light → minSeverity = 'major'
    - Given 0 providers → minAgreement = 1
  </behavior>
  <implementation>
    1. In executeReview(), after determining reviewIntensity, add threshold calculation:
       - Read consensusThreshold from config.intensityConsensusThresholds[reviewIntensity]
       - Read severityFilter from config.intensitySeverityFilters[reviewIntensity]
       - Calculate minAgreement = Math.ceil((consensusThreshold / 100) * providers.length)
       - Handle edge case: if providers.length === 0, use minAgreement = 1

    2. Modify ConsensusEngine instantiation (currently around line 575):
       - Pass calculated minAgreement instead of config.inlineMinAgreement
       - Pass severityFilter instead of config.inlineMinSeverity

    3. Add debug logging for threshold decisions

    4. Write unit tests that mock provider count and verify ConsensusEngine receives correct values
  </implementation>
</feature>

<verification>
```bash
# Run orchestrator tests
npm test -- --testPathPattern="orchestrator" --verbose

# Run intensity tests
npm test -- --testPathPattern="intensity" --verbose

# Run consensus tests (regression)
npm test -- --testPathPattern="consensus" --verbose

# Verify TypeScript compiles
npx tsc --noEmit
```
</verification>

<success_criteria>
- Tests verify consensus thresholds convert correctly from percentages
- Tests verify severity filters pass through for each intensity
- Tests verify edge case handling (0 providers)
- Tests verify fallback to defaults when config missing
- Existing orchestrator tests continue to pass
- Existing consensus tests continue to pass
- Debug logging shows threshold calculations
</success_criteria>

<output>
After completion, create `.planning/phases/07-behavior-wiring/07-02-SUMMARY.md`
</output>
