name: "Multi-Provider Code Review"
description: "Run code reviews with multiple providers using OpenCode"

inputs:
  GITHUB_TOKEN:
    description: "GitHub token"
    required: true
  REVIEW_PROVIDERS:
    description: "Comma-separated list of review providers (OpenRouter first by default)"
    required: false
    default: "openrouter/google/gemini-2.0-flash-exp:free,openrouter/mistralai/devstral-2512:free,openrouter/xiaomi/mimo-v2-flash:free"
  PR_TITLE:
    description: "PR title"
    required: true
  PR_NUMBER:
    description: "PR number"
    required: true
  PR_BODY:
    description: "PR body"
    required: true
  HAS_AGENTS:
    description: "Whether AGENTS.md exists"
    required: false
    default: "false"
  SYNTHESIS_MODEL:
    description: "Model used to synthesize provider outputs"
    required: false
    default: "openrouter/google/gemini-2.0-flash-exp:free"
  DIFF_MAX_BYTES:
    description: "Maximum diff bytes to include in prompt"
    required: false
    default: "120000"
  RUN_TIMEOUT_SECONDS:
    description: "Seconds to allow each model run before timing out"
    required: false
    default: "600"
  OPENROUTER_API_KEY:
    description: "API key for OpenRouter providers (optional)"
    required: false
  INLINE_MAX_COMMENTS:
    description: "Maximum inline review comments to post from structured findings"
    required: false
    default: "5"
  INLINE_MIN_SEVERITY:
    description: "Minimum severity for inline comments (critical, major, or minor)"
    required: false
    default: "major"
  INLINE_MIN_AGREEMENT:
    description: "Minimum number of providers that must agree before posting inline"
    required: false
    default: "1"
  REPORT_BASENAME:
    description: "Base filename for exported review reports (JSON/SARIF)"
    required: false
    default: "multi-provider-review"

runs:
  using: "composite"
  steps:
    - name: Run Multi-Provider Review
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.GITHUB_TOKEN }}
        REVIEW_PROVIDERS: ${{ inputs.REVIEW_PROVIDERS }}
        PR_TITLE: ${{ inputs.PR_TITLE }}
        PR_NUMBER: ${{ inputs.PR_NUMBER }}
        PR_BODY: ${{ inputs.PR_BODY }}
        HAS_AGENTS: ${{ inputs.HAS_AGENTS }}
        SYNTHESIS_MODEL: ${{ inputs.SYNTHESIS_MODEL }}
        DIFF_MAX_BYTES: ${{ inputs.DIFF_MAX_BYTES }}
        RUN_TIMEOUT_SECONDS: ${{ inputs.RUN_TIMEOUT_SECONDS }}
        OPENROUTER_API_KEY: ${{ inputs.OPENROUTER_API_KEY }}
        INLINE_MAX_COMMENTS: ${{ inputs.INLINE_MAX_COMMENTS }}
        INLINE_MIN_SEVERITY: ${{ inputs.INLINE_MIN_SEVERITY }}
        INLINE_MIN_AGREEMENT: ${{ inputs.INLINE_MIN_AGREEMENT }}
        REPORT_BASENAME: ${{ inputs.REPORT_BASENAME }}
      run: bash "${{ github.action_path }}/action.sh"

branding:
  icon: "code-review"
  color: "blue"
